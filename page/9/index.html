<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  
  <title>刘涤生 - 应尽便须尽 | MICHAEL</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  
  <meta name="theme-color" content="#1EF128">
  
  
  <meta name="keywords" content="undefined">
  <meta name="description" content="像外行一样思考,像专家一样实践。">
<meta property="og:type" content="website">
<meta property="og:title" content="刘涤生 - 应尽便须尽">
<meta property="og:url" content="http://yoursite.com/page/9/index.html">
<meta property="og:site_name" content="刘涤生 - 应尽便须尽">
<meta property="og:description" content="像外行一样思考,像专家一样实践。">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="刘涤生 - 应尽便须尽">
<meta name="twitter:description" content="像外行一样思考,像专家一样实践。">
  
    <link rel="alternative" href="/atom.xml" title="刘涤生 - 应尽便须尽" type="application/atom+xml">
  
  <link rel="shortcut icon" href="/icon.jpg">
  <link rel="stylesheet" href="/css/style.css?v=1.2.7">
</head>

<body>
  <div id="loading" class="active"></div>

  <aside id="menu"  >
  <div class="inner flex-row-vertical">
    <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menu-off">
        <i class="icon icon-lg icon-close"></i>
    </a>
    <div class="brand-wrap">
      <div class="brand">
        <a href="/" class="avatar waves-effect waves-circle waves-light">
          <img src="/icon.jpg">
        </a>
        <hgroup class="introduce">
          <h5 class="nickname">刘涤生</h5>
          <a href="mailto:michaelliu0727@gmail.com" title="michaelliu0727@gmail.com" class="mail">michaelliu0727@gmail.com</a>
        </hgroup>
      </div>
    </div>
    <div class="scroll-wrap flex-col">
      <ul class="nav">
        
            <li class="waves-block waves-effect">
              <a href="/"  >
                <i class="icon icon-lg icon-home"></i>
                主页
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/archives"  >
                <i class="icon icon-lg icon-archives"></i>
                归档
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/tags"  >
                <i class="icon icon-lg icon-tags"></i>
                标签
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/categories"  >
                <i class="icon icon-lg icon-th-list"></i>
                分类
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="https://github.com/liuguoquan727" target="_blank" >
                <i class="icon icon-lg icon-github"></i>
                Github
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="http://weibo.com/liuguoquan0727" target="_blank" >
                <i class="icon icon-lg icon-weibo"></i>
                Weibo
              </a>
            </li>
        
            <li class="waves-block waves-effect">
              <a href="/about"  >
                <i class="icon icon-lg icon-link"></i>
                关于
              </a>
            </li>
        
      </ul>

      <footer class="footer">
  <p><a rel="license" target="_blank" href="http://creativecommons.org/licenses/by-nc-sa/4.0/"><img alt="Creative Commons License" style="border-width:0;vertical-align:middle;" src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAFAAAAAPCAMAAABEF7i9AAAAllBMVEUAAAD///+rsapERER3d3eIiIjMzMzu7u4iIiKUmZO6v7rKzsoODg4RERFVVVUNDQ0NDg0PEA8zMzNLTEtbXltmZmZydnF9gn2AgICPkI+ZmZmqqqq7u7vFxsXIzMgNDQwZGRkgICAhISEkJSMnKCcuMC4xMzE5Ozk7PTtBQkFCQkJDQ0Nna2eGhoaHh4ezuLLGysbd3d1wVGpAAAAA4UlEQVR42q2T1xqCMAyFk7QsBQeKA9x7j/d/OSm22CpX0nzcpA1/T05aAOuBVkMAScQFHLnEwoCo2f1TnQIGoVMewjZEjVFN4GH1Ue1Cn2jWqwfsOOj6wDwGvotsl/c8lv7KIq1eLOsT0HMFHMIE/RZyHnlphryT9zyV+8WH5e8yQw3wnQvgAFxPTKUVi555SHR/lOfLMgVTeDlSfN+TaoUsiTyeIm+bCkHvCA2FUKG48LDtYBZBknsYP/G8NTw0gaaHyuQf4H5pecrB/FYCT2sL9zAfy1Xyjou6L8X2W7YcLyBZCRtnq/zfAAAAAElFTkSuQmCC" /></a></p>
  <p>刘涤生 - 应尽便须尽 &copy; 2015 - 2016</p>
  <p>Power by <a href="http://hexo.io/" target="_blank">Hexo</a> Theme
  <a href="https://github.com/yscoder/hexo-theme-indigo" target="_blank">indigo</a></p>
  <a href="/atom.xml" target="_blank" class="rss" title="rss"><i class="icon icon-2x icon-rss-square"></i></a>
</footer>

    </div>
  </div>
</aside>

  <main id="main">
    <header class="top-header" id="header">
    <div class="flex-row">
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light on" id="menu-toggle">
          <i class="icon icon-lg icon-navicon"></i>
        </a>
        <div class="flex-col header-title ellipsis">刘涤生 - 应尽便须尽</div>
        
        <div class="search-wrap" id="search-wrap">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="back">
                <i class="icon icon-lg icon-chevron-left"></i>
            </a>
            <input type="text" id="key" class="search-input" autocomplete="off" placeholder="输入感兴趣的关键字">
            <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="search">
                <i class="icon icon-lg icon-search"></i>
            </a>
        </div>
        
        
        <a href="javascript:;" class="header-icon waves-effect waves-circle waves-light" id="menuShare">
            <i class="icon icon-lg icon-share-alt"></i>
        </a>
        
    </div>
</header>
<header class="content-header index-header">

    <div class="container fade-scale">
        <h1 class="title">刘涤生 - 应尽便须尽</h1>
        <h5 class="subtitle">
            
                MICHAEL
            
        </h5>
    </div>

    

</header>

<div class="container body-wrap">

    <ul class="post-list">
    
        <li class="post-list-item fade">
            <article id="post-Android 5.x之 Notification"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time datetime="2016-02-18T14:46:03.000Z" itemprop="datePublished" class="post-time">
  2016-02-18 22:46:03
</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/">Android</a></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2016/02/18/Android 5.x之 Notification/">Android 5.x之 Notification</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent" >

    
        <p>Notification可以让我们在获得消息的时候，在状态栏、锁屏界面来显示相应的消息，如果没有Notification的话，很难想象我们的QQ和微信以及其他应用就没有办法主动通知我们，我们需要时候打开手机检查是否有新的消息到来，而这着实让人不爽。接下来，我们介绍三种Notification，分别是普通Notification，折叠式Notification和悬挂式Notification。</p>
<p>##1.普通Notification</p>
<p>首先，创建Builder对象，创建一个PendingIntent来实现消息点击跳转事件。</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">Notification.Builder builder = <span class="keyword">new</span> <span class="type">Notification</span>.Builder(<span class="built_in">this</span>);</div><div class="line">Intent intent = <span class="keyword">new</span> <span class="type">Intent</span>(Intent.ACTION_VIEW, Uri.parse(<span class="string">"https://www.baidu.com/"</span>));</div><div class="line">PendingIntent pendingIntent = PendingIntent.getActivity(<span class="built_in">this</span>,<span class="number">0</span>,intent,<span class="number">0</span>);</div></pre></td></tr></table></figure>
<p>其次，通过builder给Notification添加不同的属性：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">builder</span><span class="selector-class">.setContentIntent</span>(<span class="selector-tag">pendingIntent</span>);</div><div class="line"><span class="selector-tag">builder</span><span class="selector-class">.setSmallIcon</span>(<span class="selector-tag">R</span><span class="selector-class">.mipmap</span><span class="selector-class">.ic_launcher</span>);</div><div class="line"><span class="selector-tag">builder</span><span class="selector-class">.setLargeIcon</span>(<span class="selector-tag">BitmapFactory</span><span class="selector-class">.decodeResource</span>(<span class="selector-tag">getResources</span>(), <span class="selector-tag">R</span><span class="selector-class">.mipmap</span><span class="selector-class">.ic_launcher</span>));</div><div class="line"><span class="selector-tag">builder</span><span class="selector-class">.setAutoCancel</span>(<span class="selector-tag">true</span>);</div><div class="line"><span class="selector-tag">builder</span><span class="selector-class">.setContentTitle</span>("普通<span class="selector-tag">Notification</span>");</div></pre></td></tr></table></figure>
<p>最后，创建NotifcationManager对象，调用notify发送一个通知</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">mManager = (NotificationManager) getSystemService(<span class="built_in">Context</span>.NOTIFICATION_SERVICE)<span class="comment">;</span></div><div class="line">mManager.notify(<span class="number">0</span>, <span class="keyword">builder.build());</span></div></pre></td></tr></table></figure>
<p>效果如下：</p>
<p><img src="http://img.blog.csdn.net/20160312221647150" alt="普通Notification"></p>
<p>##2.折叠式Notification</p>
<p>折叠式Notification是一种自定义视图的Notification，用来显示长文本和一些自定义的布局的场景。它有两种状态，一种是普通状态下的视图（如果不是自定义的话和上面普通通知的视图样式一样）；一种是展开状态下的视图，它需要自定义视图，并且这个自定义视图的显示的进程和我们创建视图的进程不是一个进程，需要使用RemoteViews。</p>
<p>首先，使用RemoteViews创建自定义视图</p>
<figure class="highlight haxe"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//用RemoteViews来创建自定义Notification视图</span></div><div class="line">RemoteViews remoteViews = <span class="keyword">new</span> <span class="type">RemoteViews</span>(getPackageName(),R.layout.fold_notification);</div></pre></td></tr></table></figure>
<p>视图的布局：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="php"><span class="meta">&lt;?</span>xml version=<span class="string">"1.0"</span> encoding=<span class="string">"utf-8"</span><span class="meta">?&gt;</span></span></div><div class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></div><div class="line">    <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></div><div class="line">    <span class="attr">android:layout_height</span>=<span class="string">"100dp"</span></div><div class="line">    <span class="attr">android:background</span>=<span class="string">"#000000"</span></div><div class="line">    <span class="attr">android:orientation</span>=<span class="string">"horizontal"</span>&gt;</div><div class="line"></div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:textColor</span>=<span class="string">"#ffffffff"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"自定义的视图"</span>/&gt;</div><div class="line">    </div><div class="line">    <span class="tag">&lt;<span class="name">TextView</span></span></div><div class="line">        <span class="attr">android:layout_width</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></div><div class="line">        <span class="attr">android:textColor</span>=<span class="string">"#ffffffff"</span></div><div class="line">        <span class="attr">android:text</span>=<span class="string">"折叠式通知"</span>/&gt;</div><div class="line"></div><div class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></div></pre></td></tr></table></figure>
<p>其次，把自定义视图赋给Notification</p>
<figure class="highlight 1c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//赋值给Notification展开时的视图</span></div><div class="line">notification.bigContentView = remoteViews;</div><div class="line">或</div><div class="line"><span class="comment">//赋值给Notification普通状态时的视图</span></div><div class="line">notification.contentView = remoteViews;</div></pre></td></tr></table></figure>
<p>折叠式Notification的完整代码为:</p>
<figure class="highlight pony"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="type">Notification</span>.<span class="type">Builder</span> builder = <span class="function"><span class="keyword">new</span> <span class="title">Notification</span>.<span class="title">Builder</span>(this);</span></div><div class="line"><span class="title">Intent</span> <span class="title">intent</span> = <span class="title">new</span> <span class="title">Intent</span>(<span class="type">Intent</span>.<span class="type">ACTION_VIEW</span>, <span class="type">Uri</span>.parse("https://www.baidu.com/"));</div><div class="line"><span class="title">PendingIntent</span> <span class="title">pendingIntent</span> = <span class="title">PendingIntent</span>.<span class="title">getActivity</span>(this,<span class="number">0</span>,intent,<span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="title">builder</span>.<span class="title">setContentIntent</span>(pendingIntent);</div><div class="line"><span class="title">builder</span>.<span class="title">setSmallIcon</span>(<span class="type">R</span>.mipmap.ic_launcher);</div><div class="line"><span class="title">builder</span>.<span class="title">setLargeIcon</span>(<span class="type">BitmapFactory</span>.decodeResource(getResources(), <span class="title">R</span>.<span class="title">mipmap</span>.<span class="title">ic_launcher</span>));</div><div class="line"><span class="title">builder</span>.<span class="title">setAutoCancel</span>(true);</div><div class="line"><span class="title">builder</span>.<span class="title">setContentTitle</span>("折叠式<span class="type">Notification</span>");</div><div class="line"></div><div class="line"><span class="comment">//用RemoteViews来创建自定义Notification视图</span></div><div class="line"><span class="title">RemoteViews</span> <span class="title">remoteViews</span> = <span class="title">new</span> <span class="title">RemoteViews</span>(getPackageName(),<span class="title">R</span>.<span class="title">layout</span>.<span class="title">fold_notification</span>);</div><div class="line"><span class="title">Notification</span> <span class="title">notification</span> = <span class="title">builder</span>.<span class="title">build</span>();</div><div class="line"><span class="comment">//指定展开的视图</span></div><div class="line"><span class="title">notification</span>.<span class="title">bigContentView</span> = <span class="title">remoteViews</span>;</div><div class="line"></div><div class="line"><span class="title">mManager</span>.<span class="title">notify</span>(<span class="number">1</span>,notification);</div></pre></td></tr></table></figure>
<p>如果不是自定义普通视图的话，折叠式Notification普通状态和普通Notification没有什么区别，效果如下。</p>
<p><img src="" alt="普通Notification"></p>
<p>接着把通知栏往下拉，使折叠式Notification完全展开就会出现自定义视图</p>
<p><img src="http://img.blog.csdn.net/20160312221555540" alt="折叠式Notification"></p>
<p>##3.悬挂式Notification</p>
<p>悬挂式Notification是Android 5.0新加的通知方式，与前两种通知不同的是，悬挂式Notification不需要下拉通知栏就直接显示出来悬挂在屏幕上方并且不会占用用户的焦点因此不会打断用户的操作，过几秒就自动消失。</p>
<p>需要调用setFullScreenIntent来讲Notification变为悬挂式Notification。</p>
<p>悬挂式Notification的代码如下:</p>
<figure class="highlight pony"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="type">Notification</span>.<span class="type">Builder</span> builder = <span class="function"><span class="keyword">new</span> <span class="title">Notification</span>.<span class="title">Builder</span>(this);</span></div><div class="line"><span class="title">Intent</span> <span class="title">intent</span> = <span class="title">new</span> <span class="title">Intent</span>(<span class="type">Intent</span>.<span class="type">ACTION_VIEW</span>, <span class="type">Uri</span>.parse("https://www.baidu.com/"));</div><div class="line"><span class="title">PendingIntent</span> <span class="title">pendingIntent</span> = <span class="title">PendingIntent</span>.<span class="title">getActivity</span>(this,<span class="number">0</span>,intent,<span class="number">0</span>);</div><div class="line"></div><div class="line"><span class="title">builder</span>.<span class="title">setContentIntent</span>(pendingIntent);</div><div class="line"><span class="title">builder</span>.<span class="title">setSmallIcon</span>(<span class="type">R</span>.mipmap.ic_launcher);</div><div class="line"><span class="title">builder</span>.<span class="title">setLargeIcon</span>(<span class="type">BitmapFactory</span>.decodeResource(getResources(), <span class="title">R</span>.<span class="title">mipmap</span>.<span class="title">ic_launcher</span>));</div><div class="line"><span class="title">builder</span>.<span class="title">setAutoCancel</span>(true);</div><div class="line"><span class="title">builder</span>.<span class="title">setContentTitle</span>("悬挂式<span class="type">Notification</span>");</div><div class="line"></div><div class="line"><span class="comment">//设置点击跳转</span></div><div class="line"><span class="title">Intent</span> <span class="title">hangIntent</span> = <span class="title">new</span> <span class="title">Intent</span>(<span class="type">Intent</span>.<span class="type">ACTION_VIEW</span>, <span class="type">Uri</span>.parse("https://www.baidu.com/"));</div><div class="line"><span class="title">hangIntent</span>.<span class="title">setFlags</span>(<span class="type">Intent</span>.<span class="type">FLAG_ACTIVITY_NEW_TASK</span>);</div><div class="line"><span class="comment">//如果描述的PendingIntent已经存在，则在产生新的Intent之前会先取消当前的</span></div><div class="line"><span class="title">PendingIntent</span> <span class="title">hangPendingIntent</span> = <span class="title">PendingIntent</span>.<span class="title">getActivity</span>(this,<span class="number">0</span>,hangIntent,<span class="type">PendingIntent</span>.<span class="type">FLAG_CANCEL_CURRENT</span>);</div><div class="line"><span class="title">builder</span>.<span class="title">setFullScreenIntent</span>(hangPendingIntent,true);</div><div class="line"></div><div class="line"><span class="title">Notification</span> <span class="title">notification</span> = <span class="title">builder</span>.<span class="title">build</span>();</div><div class="line"></div><div class="line"><span class="title">mManager</span>.<span class="title">notify</span>(<span class="number">2</span>,notification);</div></pre></td></tr></table></figure>
<p>效果如下：</p>
<p><img src="http://img.blog.csdn.net/20160312221613018" alt="折叠式Notification"></p>
<p>##4.Notification的等级</p>
<p>Android5.0加入了一种新的模式Notification的等级，有三种：</p>
<ul>
<li>VISIBILITY_PUBLIC 只有在没有锁屏时会显示通知</li>
<li>VISIBILITY_PRIVATE 任何情况都会显示通知</li>
<li>VISIBILITY_SECRET 在安全锁和没有锁屏的情况下显示通知</li>
</ul>
<p>只需通过Builder的setVisibility方法就可以了</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">builder</span><span class="selector-class">.setVisibility</span>(<span class="selector-tag">Notification</span><span class="selector-class">.VISIBILITY_PUBLIC</span>);</div></pre></td></tr></table></figure>
<p>##参考文章</p>
<p><a href="http://blog.csdn.net/itachi85/article/details/50096609" target="_blank" rel="external"> Android5.x Notification应用解析 </a></p>

    

        <a href="/2016/02/18/Android 5.x之 Notification/" class="post-more waves-effect waves-button">
            阅读全文...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android5-X/">Android5.X</a></li></ul>

    </div>
    
</article>

        </li>
    
        <li class="post-list-item fade">
            <article id="post-Android_Jni头文件分析"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time datetime="2016-01-17T07:32:23.000Z" itemprop="datePublished" class="post-time">
  2016-01-17 15:32:23
</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/">Android</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/NDK/">NDK</a></li></ul></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2016/01/17/Android_Jni头文件分析/">Jni头文件分析</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent" >

    
        <h2 id="编写Java文件"><a href="#编写Java文件" class="headerlink" title="编写Java文件"></a>编写Java文件</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HeaderFile</span> </span>&#123;  </div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span>  <span class="title">doVoid</span><span class="params">()</span></span>;  </div><div class="line">    <span class="function"><span class="keyword">native</span> <span class="keyword">int</span> <span class="title">doShort</span><span class="params">()</span></span>;  </div><div class="line">    <span class="function"><span class="keyword">native</span> <span class="keyword">void</span> <span class="title">doArray</span><span class="params">(Object[] o )</span></span>;  </div><div class="line">    <span class="function"><span class="keyword">native</span> <span class="keyword">int</span> <span class="title">doInt</span><span class="params">(<span class="keyword">int</span> i)</span></span>;      <span class="comment">//byte ,short ,int,long,float,double ,boolean,char        </span></div><div class="line">    <span class="function"><span class="keyword">native</span> <span class="keyword">int</span> <span class="title">doInt</span><span class="params">(<span class="keyword">double</span> d)</span></span>;    <span class="comment">//byte ,short ,int,long,float,double ,boolean,char  </span></div><div class="line">    <span class="function"><span class="keyword">native</span> <span class="keyword">int</span> <span class="title">doInt</span><span class="params">(Object o)</span></span>;      </div><div class="line">    <span class="function"><span class="keyword">native</span> <span class="keyword">int</span> <span class="title">doInt</span><span class="params">(<span class="keyword">double</span> d1,<span class="keyword">double</span> d2)</span></span>;  </div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">doInt</span><span class="params">(<span class="keyword">double</span> d1 ,<span class="keyword">double</span> d2,<span class="keyword">double</span> d3)</span></span>;  </div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">doInt</span><span class="params">(<span class="keyword">double</span> d1 ,<span class="keyword">float</span> f,<span class="keyword">boolean</span> b ,<span class="keyword">char</span>[] c )</span></span>;    </div><div class="line">     </div><div class="line">    <span class="function"><span class="keyword">native</span> <span class="keyword">int</span> <span class="title">doInt</span><span class="params">(<span class="keyword">int</span>[] i)</span></span>;  </div><div class="line">    <span class="function"><span class="keyword">native</span> <span class="keyword">int</span> <span class="title">doInt</span><span class="params">(<span class="keyword">int</span>[] i1,<span class="keyword">double</span>[] i2 )</span></span>;      </div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">doInt</span><span class="params">(<span class="keyword">int</span>[] i1,<span class="keyword">double</span>[] i2 ,Object[] o )</span></span>;  </div><div class="line">     </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">doString</span><span class="params">(String s)</span></span>;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> Object <span class="title">doObject</span><span class="params">(Object o )</span></span>;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> Enumeration <span class="title">doInterface</span><span class="params">(Iterator it)</span></span>;  </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> Student <span class="title">doStudent</span><span class="params">(Student s)</span></span>;  </div><div class="line">     </div><div class="line"><span class="comment">//  native int[] doInt(int[] i);  //byte ,short ,int,long,float,double ,boolean,char  </span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">native</span> String[] doString(String[] s);  </div><div class="line">    <span class="keyword">public</span> <span class="keyword">native</span> Object[] doObjects(Object[] o );  </div><div class="line">    <span class="keyword">public</span> <span class="keyword">native</span> Enumeration[] doInterface(Iterator[] it);  </div><div class="line">    <span class="keyword">public</span> <span class="keyword">native</span> Student[] doStudent(Student[] s);  </div><div class="line">            </div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">static</span> Object <span class="title">doAll</span><span class="params">(<span class="keyword">int</span>[] i , String[] s , Student[] student )</span></span>;               </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="生成头文件"><a href="#生成头文件" class="headerlink" title="生成头文件"></a>生成头文件</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* DO NOT EDIT THIS FILE - it is machine generated */</span>  </div><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;jni.h&gt;</span>  </span></div><div class="line"><span class="comment">/* Header for class com_nedu_jni_helloword_HeaderFile */</span>  </div><div class="line">  </div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> _Included_com_nedu_jni_helloword_HeaderFile  </span></div><div class="line"><span class="meta">#<span class="meta-keyword">define</span> _Included_com_nedu_jni_helloword_HeaderFile  </span></div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus  </span></div><div class="line"><span class="keyword">extern</span> <span class="string">"C"</span> &#123;  </div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doVoid </div><div class="line"> * Signature: ()V </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doVoid</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jobject)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doShort </div><div class="line"> * Signature: ()I </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doShort</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jobject)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doArray </div><div class="line"> * Signature: ([Ljava/lang/Object;)V </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doArray</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jobject, jobjectArray)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doInt </div><div class="line"> * Signature: (I)I </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doInt__I</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jobject, jint)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doInt </div><div class="line"> * Signature: (D)I </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doInt__D</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jobject, jdouble)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doInt </div><div class="line"> * Signature: (Ljava/lang/Object;)I </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doInt__Ljava_lang_Object_2</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jobject, jobject)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doInt </div><div class="line"> * Signature: (DD)I </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doInt__DD</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jobject, jdouble, jdouble)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doInt </div><div class="line"> * Signature: (DDD)I </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doInt__DDD</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jclass, jdouble, jdouble, jdouble)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doInt </div><div class="line"> * Signature: (DFZ[C)I </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doInt__DFZ_3C</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jclass, jdouble, jfloat, jboolean, jcharArray)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doInt </div><div class="line"> * Signature: ([I)I </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doInt___3I</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jobject, jintArray)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doInt </div><div class="line"> * Signature: ([I[D)I </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doInt___3I_3D</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jobject, jintArray, jdoubleArray)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doInt </div><div class="line"> * Signature: ([I[D[Ljava/lang/Object;)I </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT jint JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doInt___3I_3D_3Ljava_lang_Object_2</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jclass, jintArray, jdoubleArray, jobjectArray)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doString </div><div class="line"> * Signature: (Ljava/lang/String;)Ljava/lang/String; </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT jstring JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doString__Ljava_lang_String_2</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jobject, jstring)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doObject </div><div class="line"> * Signature: (Ljava/lang/Object;)Ljava/lang/Object; </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT jobject JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doObject</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jobject, jobject)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doInterface </div><div class="line"> * Signature: (Ljava/util/Iterator;)Ljava/util/Enumeration; </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT jobject JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doInterface__Ljava_util_Iterator_2</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jobject, jobject)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doStudent </div><div class="line"> * Signature: (Lcom/nedu/jni/helloword/Student;)Lcom/nedu/jni/helloword/Student; </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT jobject JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doStudent__Lcom_nedu_jni_helloword_Student_2</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jobject, jobject)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doString </div><div class="line"> * Signature: ([Ljava/lang/String;)[Ljava/lang/String; </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT jobjectArray JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doString___3Ljava_lang_String_2</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jobject, jobjectArray)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doObjects </div><div class="line"> * Signature: ([Ljava/lang/Object;)[Ljava/lang/Object; </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT jobjectArray JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doObjects</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jobject, jobjectArray)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doInterface </div><div class="line"> * Signature: ([Ljava/util/Iterator;)[Ljava/util/Enumeration; </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT jobjectArray JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doInterface___3Ljava_util_Iterator_2</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jobject, jobjectArray)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doStudent </div><div class="line"> * Signature: ([Lcom/nedu/jni/helloword/Student;)[Lcom/nedu/jni/helloword/Student; </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT jobjectArray JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doStudent___3Lcom_nedu_jni_helloword_Student_2</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jobject, jobjectArray)</span>;  </div><div class="line">  </div><div class="line"><span class="comment">/* </span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doAll </div><div class="line"> * Signature: ([I[Ljava/lang/String;[Lcom/nedu/jni/helloword/Student;)Ljava/lang/Object; </div><div class="line"> */  </div><div class="line"><span class="function">JNIEXPORT jobject JNICALL <span class="title">Java_com_nedu_jni_helloword_HeaderFile_doAll</span>  </span></div><div class="line">  <span class="params">(JNIEnv *, jclass, jintArray, jobjectArray, jobjectArray)</span>;  </div><div class="line">  </div><div class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> __cplusplus  </span></div><div class="line">&#125;  </div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span>  </span></div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div></pre></td></tr></table></figure>
<p>##3.头文件分析</p>
<p>###3.1 方法注释</p>
<pre><code>/*  
 * Class:     com_nedu_jni_helloword_HeaderFile  
 * Method:    doVoid  
 * Signature: ()V  
 */  
</code></pre><p>Class：表示Native方法的类名称<br>Method：表示方法名称<br>Signature：是方法的标识，主要提供我们再JNI操作java对象中使用  </p>
<p>Signature一般 是两部分构成，一个方法的参数。另一个是返回类型。方法参数在括号里面，返回类型在后面，例如：</p>
<pre><code>()V 
</code></pre><p>返回值为void，没有参数。  </p>
<pre><code>(DFZ[C)I 
</code></pre><p>返回值为int，参数为double、float、char[]  </p>
<pre><code>(Ljava/lang/String;)Ljava/lang/String;
</code></pre><p>返回值String，参数为String</p>
<ul>
<li>基本类型的对应关系如下</li>
</ul>
<p><img src="http://hi.csdn.net/attachment/201111/11/0_132099442294XE.gif" alt="ALT TEXT"> </p>
<ul>
<li><p>方法参数或者返回值为java中的对象时，必须以“L”加上其路径，次路径必须以”/“分开，自定义的对象也使用本规则，不在包中时直接”L”，比如说java.lang.String为“java/lang/String”,com.nedu.jni.helloword.Student为”com/nedu/jni/helloword/Student”</p>
</li>
<li><p>方法)方法参数或者返回值为数组时类型前加上[,例如[I表示int[],[[[D表示 double[][][]，即几维数组就加几个[。例子如下：</p>
</li>
</ul>
<p><img src="http://hi.csdn.net/attachment/201111/11/0_1320994986OoPN.gif" alt="ALT TEXT"></p>
<p>###3.2 方法的声明</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">JNIEXPORT </span>void <span class="keyword">JNICALL </span><span class="keyword">Java_com_nedu_jni_helloword_HeaderFile_doArray(JNIEnv </span>*,<span class="keyword">jobject,jobjectArray);</span></div></pre></td></tr></table></figure>
<p>从声明可以看出方法基本由7部分组成：</p>
<ol>
<li>JNIEXPORT是JNI的关键字，表示此函数时要被JNI调用的</li>
<li>void表示方法的返回值类型</li>
<li>JNICALL是JNI的关键字，表示此函数时要被JNI调用的</li>
<li>Java_为JNI中表示此方法来源于java的标志头</li>
<li>com_nedu_jni_helloword_HeaderFile表示方法所在的包名+类名</li>
<li>doArray表示方法名</li>
<li>参数：JNIEnv*是一个接口指针，用于定位函数表中的函数，后面的jobject是  一个指向该类的指针，类似与C语言中的this。这个第二个参数是变化的，当该方法为类的实例方法时该参数为jobject；当该方法为类方法（即静态方法）时该参数为jclass，指向该类的class。</li>
</ol>
<p>根据不同方法前缀生成的头文件比较如下：</p>
<ul>
<li><p>static与非static的比较</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/* 非static方法</span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doInt </div><div class="line"> * Signature: (DD)I </div><div class="line"> */  </div><div class="line"><span class="keyword">JNIEXPORT </span><span class="keyword">jint </span><span class="keyword">JNICALL </span><span class="keyword">Java_com_nedu_jni_helloword_HeaderFile_doInt__DD </span> </div><div class="line">  (<span class="keyword">JNIEnv </span>*, <span class="keyword">jobject, </span><span class="keyword">jdouble, </span><span class="keyword">jdouble); </span> </div><div class="line"> </div><div class="line"><span class="comment">/* static方法</span></div><div class="line"> * Class:     com_nedu_jni_helloword_HeaderFile </div><div class="line"> * Method:    doInt </div><div class="line"> * Signature: (DDD)I </div><div class="line"> */  </div><div class="line"><span class="keyword">JNIEXPORT </span><span class="keyword">jint </span><span class="keyword">JNICALL </span><span class="keyword">Java_com_nedu_jni_helloword_HeaderFile_doInt__DDD </span> </div><div class="line">  (<span class="keyword">JNIEnv </span>*, <span class="keyword">jclass, </span><span class="keyword">jdouble, </span><span class="keyword">jdouble, </span><span class="keyword">jdouble);</span></div></pre></td></tr></table></figure>
</li>
<li><p>private、friendly、protected以及public这些方法限制符不会在JNI的头文件中出现。这些访问修饰符只有在其它类使用这些方法时有效！JNI中不关心此修饰符！</p>
</li>
</ul>

    

        <a href="/2016/01/17/Android_Jni头文件分析/" class="post-more waves-effect waves-button">
            阅读全文...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NDK/">NDK</a></li></ul>

    </div>
    
</article>

        </li>
    
        <li class="post-list-item fade">
            <article id="post-Android_Jni参数类型与Java参数类型对比"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time datetime="2016-01-17T07:32:11.000Z" itemprop="datePublished" class="post-time">
  2016-01-17 15:32:11
</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/">Android</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/NDK/">NDK</a></li></ul></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2016/01/17/Android_Jni参数类型与Java参数类型对比/">Jni参数类型与Java参数类型对比</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent" >

    
        <p>##区别</p>
<ul>
<li><p>Java中的返回值void和JNI中的void完全对应（仅仅一个）</p>
</li>
<li><p>Java中的基本数据类型（byte ,short ,int,long,float,double ,boolean,char－8种）在JNI中对应的数据类型只要在前面加上j就可以了（jbyte ,jshort ,jint,jlong,jfloat,jdouble ,jboolean,jchar）</p>
</li>
<li><p>Java中的对象，包括类库中定义的类、接口以及自定义类接口，都对应于JNI中的jobject</p>
</li>
<li><p>Java中的基本数据类型对应的数组对应于JNI中的j<type>Array类型（type就是8中基本数据类型）</type></p>
</li>
<li><p>Java中对象的数组对应于JNI中的jobjectArray类型</p>
</li>
</ul>
<p>##基本数据类型映射图</p>
<p><img src="http://hi.csdn.net/attachment/201111/10/0_13209061602sLG.gif" alt="ALT TEXT"></p>
<p>##引用数据类型的映射图</p>
<p><img src="http://hi.csdn.net/attachment/201111/10/0_1320906175mxw4.gif" alt="ALT TEXT"></p>

    

        <a href="/2016/01/17/Android_Jni参数类型与Java参数类型对比/" class="post-more waves-effect waves-button">
            阅读全文...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NDK/">NDK</a></li></ul>

    </div>
    
</article>

        </li>
    
        <li class="post-list-item fade">
            <article id="post-Android-NDk开发流程"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time datetime="2016-01-17T07:31:57.000Z" itemprop="datePublished" class="post-time">
  2016-01-17 15:31:57
</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/">Android</a><ul class="article-category-list-child"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Android/NDK/">NDK</a></li></ul></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2016/01/17/Android-NDk开发流程/">Android NDk开发流程</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent" >

    
        <h2 id="Java编写native方法"><a href="#Java编写native方法" class="headerlink" title="Java编写native方法"></a>Java编写native方法</h2><p>新建JniUtil类如下:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JniUtil</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 回调接口</div><div class="line">	 * <span class="doctag">@author</span> jimi098</div><div class="line">	 *</div><div class="line">	 */</div><div class="line">	<span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IRecFrameListener</span> </span>&#123;</div><div class="line">		</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRecFrameListener</span><span class="params">(String result)</span></span>;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> IRecFrameListener mListener;</div><div class="line">	</div><div class="line">	</div><div class="line">	<span class="keyword">static</span> &#123;</div><div class="line">		</div><div class="line">		System.loadLibrary(<span class="string">"test"</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setOnRecFrameListener</span><span class="params">(IRecFrameListener listener)</span> </span>&#123;</div><div class="line">		</div><div class="line">		mListener = listener;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 供jni调用的java方法</div><div class="line">	 * <span class="doctag">@param</span> result</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRecFrame</span><span class="params">(<span class="keyword">int</span> result)</span> </span>&#123;</div><div class="line">		mListener.onRecFrameListener(String.valueOf(result));</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">//java本地方法</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">init</span><span class="params">()</span></span>;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">native</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a,<span class="keyword">int</span> b)</span></span>;</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">native</span> String <span class="title">getString</span><span class="params">(String input)</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="生成-h头文件"><a href="#生成-h头文件" class="headerlink" title="生成.h头文件"></a>生成.h头文件</h2><p>编译JniUtil类，生成JniUtil.class文件，然后在cmd中切换目录至android工程的src文件夹路径，运行<code>javah -jni com.example.demo.JniUtil</code>命令即可生成.h头文件</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">#include &lt;jni.h&gt;</div><div class="line">#include &lt;android/log.h&gt;</div><div class="line"></div><div class="line">//logcat日志</div><div class="line">#define  LOG_TAG    "Test"</div><div class="line">#define  LOGI(...)  __android_log_print(ANDROID_LOG_INFO,LOG_TAG,__VA_ARGS__)</div><div class="line">#define  LOGE(...)  __android_log_print(ANDROID_LOG_ERROR,LOG_TAG,__VA_ARGS__)</div><div class="line">/* Header for class com_example_demo_JniUtil */</div><div class="line"></div><div class="line">#ifndef _Included_com_example_demo_JniUtil</div><div class="line">#define _Included_com_example_demo_JniUtil</div><div class="line">#ifdef __cplusplus</div><div class="line">extern "C" &#123;</div><div class="line">#endif</div><div class="line">/*</div><div class="line"> * Class:     com_example_demo_JniUtil</div><div class="line"> * Method:    init</div><div class="line"> * Signature: ()I</div><div class="line"> */</div><div class="line">JNIEXPORT jint JNICALL Java_com_example_demo_JniUtil_init</div><div class="line">  (JNIEnv *, jobject);</div><div class="line"></div><div class="line">/*</div><div class="line"> * Class:     com_example_demo_JniUtil</div><div class="line"> * Method:    add</div><div class="line"> * Signature: (II)I</div><div class="line"> */</div><div class="line">JNIEXPORT jint JNICALL Java_com_example_demo_JniUtil_add</div><div class="line">  (JNIEnv *, jobject, jint, jint);</div><div class="line"></div><div class="line">/*</div><div class="line"> * Class:     com_example_demo_JniUtil</div><div class="line"> * Method:    getString</div><div class="line"> * Signature: (Ljava/lang/String;)Ljava/lang/String;</div><div class="line"> */</div><div class="line">JNIEXPORT jstring JNICALL Java_com_example_demo_JniUtil_getString</div><div class="line">  (JNIEnv *, jobject, jstring);</div><div class="line"></div><div class="line">#ifdef __cplusplus</div><div class="line">&#125;</div><div class="line">#endif</div><div class="line">#endif</div></pre></td></tr></table></figure>
<h2 id="实现jni"><a href="#实现jni" class="headerlink" title="实现jni"></a>实现jni</h2><p>新建jni文件夹，实现本地java方法</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">#include&lt;jniutil.h&gt;</div><div class="line"></div><div class="line">jobject mObject;</div><div class="line"></div><div class="line"></div><div class="line">JNIEXPORT jint JNICALL Java_com_example_demo_JniUtil_init(JNIEnv *env,</div><div class="line">		jobject obj) &#123;</div><div class="line"></div><div class="line">	//获取全局对象</div><div class="line">	mObject = (*env)-&gt;NewGlobalRef(env, obj);</div><div class="line"></div><div class="line">	jmethodID methodID;</div><div class="line">	jclass mClass;</div><div class="line"></div><div class="line">	//查找指定名称类</div><div class="line">	mClass = (*env)-&gt;GetObjectClass(env, mObject);;</div><div class="line"></div><div class="line">	//获取方法ID</div><div class="line">	methodID = (*env)-&gt;GetMethodID(env,mClass,"onRecFrame","(I)V");</div><div class="line"></div><div class="line">	//调用上层java方法</div><div class="line">	(*env)-&gt;CallVoidMethod(env,obj,methodID,89);</div><div class="line"></div><div class="line">	return 5;</div><div class="line">&#125;</div><div class="line"></div><div class="line">/*</div><div class="line"> * Class:     com_example_demo_JniUtil</div><div class="line"> * Method:    add</div><div class="line"> * Signature: (II)I</div><div class="line"> */</div><div class="line">JNIEXPORT jint JNICALL Java_com_example_demo_JniUtil_add(JNIEnv *env,</div><div class="line">		jobject obj, jint x, jint y) &#123;</div><div class="line"></div><div class="line">	return x + y;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">/*</div><div class="line"> * Class:     com_example_demo_JniUtil</div><div class="line"> * Method:    getString</div><div class="line"> * Signature: (Ljava/lang/String;)Ljava/lang/String;</div><div class="line"> */</div><div class="line">JNIEXPORT jstring JNICALL Java_com_example_demo_JniUtil_getString(JNIEnv *env,</div><div class="line">		jobject obj, jstring result) &#123;</div><div class="line"></div><div class="line">	return result;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="编写mk文件"><a href="#编写mk文件" class="headerlink" title="编写mk文件"></a>编写mk文件</h2><h3 id="Android-mk"><a href="#Android-mk" class="headerlink" title="Android.mk"></a>Android.mk</h3><p>指定编译规则</p>
<figure class="highlight elixir"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">LOCAL_PATH <span class="symbol">:</span>= <span class="variable">$(</span>call my-dir)</div><div class="line"></div><div class="line"><span class="keyword">include</span> <span class="variable">$(</span>CLEAR_VARS)</div><div class="line"></div><div class="line">LOCAL_MODULE    <span class="symbol">:</span>= test</div><div class="line">LOCAL_SRC_FILES <span class="symbol">:</span>= test.c</div><div class="line"></div><div class="line">LOCAL_LDLIBS    <span class="symbol">:</span>= -llog</div><div class="line"><span class="keyword">include</span> <span class="variable">$(</span>BUILD_SHARED_LIBRARY)</div></pre></td></tr></table></figure>
<h3 id="Application-mk"><a href="#Application-mk" class="headerlink" title="Application.mk"></a>Application.mk</h3><p>指定编译平台</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">APP_ABI := armeabi armeabi-v7a</div><div class="line">APP_PLATFORM := android<span class="number">-22</span></div><div class="line">APP_STL:=gnustl_static</div><div class="line">APP_CPPFLAGS:=-frtti -fexceptions</div></pre></td></tr></table></figure>
<h2 id="配置NDK执行编译"><a href="#配置NDK执行编译" class="headerlink" title="配置NDK执行编译"></a>配置NDK执行编译</h2><p>右击工程–》Properties–》Builders–》New–》选择Program–》Main–》Location：选择ndk-build.cmd命令路径–》Working Directory：选择工程路径–》Refresh–》Build Options，配置完成后即可自动编译，不需要安装cygwin linux模拟环境</p>
<p>##6.应用jni</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> <span class="keyword">implements</span> <span class="title">OnClickListener</span>, <span class="title">IRecFrameListener</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> Button mButton;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> JniUtil mJniUtil;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</div><div class="line">        setContentView(R.layout.activity_main);</div><div class="line">        </div><div class="line">        mButton = (Button) findViewById(R.id.btn_click);</div><div class="line">        mButton.setOnClickListener(<span class="keyword">this</span>);</div><div class="line">        mJniUtil = <span class="keyword">new</span> JniUtil();</div><div class="line">        mJniUtil.setOnRecFrameListener(<span class="keyword">this</span>);</div><div class="line">        </div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onClick</span><span class="params">(View v)</span> </span>&#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">		System.out.println(<span class="string">"init: "</span> + mJniUtil.init());</div><div class="line">		System.out.println(<span class="string">"sum: "</span>+ mJniUtil.add(<span class="number">1</span>, <span class="number">2</span>));</div><div class="line">		System.out.println(<span class="string">"getString: "</span> + mJniUtil.getString(<span class="string">"wert"</span>));</div><div class="line">	&#125;</div><div class="line"></div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 回调，由jni方法返回数据</div><div class="line">	 */</div><div class="line">	<span class="meta">@Override</span></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onRecFrameListener</span><span class="params">(String result)</span> </span>&#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">		System.out.println(result);</div><div class="line">		</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
    

        <a href="/2016/01/17/Android-NDk开发流程/" class="post-more waves-effect waves-button">
            阅读全文...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/NDK/">NDK</a></li></ul>

    </div>
    
</article>

        </li>
    
        <li class="post-list-item fade">
            <article id="post-Java并发编程之线程同步"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time datetime="2015-12-26T14:04:06.000Z" itemprop="datePublished" class="post-time">
  2015-12-26 22:04:06
</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Java/">Java</a></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2015/12/26/Java并发编程之线程同步/">Java并发编程之多线程同步</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent" >

    
        <p>线程安全就是防止某个对象或者值在多个线程中被修改而导致的数据不一致问题，因此我们就需要通过同步机制保证在同一时刻只有一个线程能够访问到该对象或数据，修改数据完毕之后，再将最新数据同步到主存中，使得其他线程都能够得到这个最新数据。下面我们就来了解Java一些基本的同步机制。</p>
<h1 id="volatile关键字"><a href="#volatile关键字" class="headerlink" title="volatile关键字"></a>volatile关键字</h1><p>Java提供了一种稍弱的同步机制即volatile变量，用来确保将变量的更新操作通知到其他线程。当把变量声明为volatile类型后，编译器与运行时都会注意到这个变量是共享的。然而，在访问volatile变量时不会执行加锁操作，因此也就不会使线程阻塞，因此volatile变量是一种比synchronized关键字更轻量级的同步机制。</p>
<p>volatile变量对所有的线程都是可见的，对volatile变量所有的写操作都能立即反应到其他线程之中，即volatile变量在各个线程中是一致的。</p>
<p>有一种情况需要注意：volatile的语义不能确保递增（count++）的原子性，除非你能确保只有一个线程对变量执行写操作。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">public class VolatileTest&#123;</div><div class="line">    </div><div class="line">    public static volatile int  i;</div><div class="line"></div><div class="line">    public static void increase()&#123;</div><div class="line">        i++;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">查看字节码: javap -c -l VolatileTest.class</div><div class="line"></div><div class="line">public class VolatileTest &#123;</div><div class="line">  public static volatile int i;</div><div class="line"> </div><div class="line">  public VolatileTest();</div><div class="line">    Code:</div><div class="line">       0: aload_0       </div><div class="line">       1: invokespecial #1                  // Method java/lang/Object."&lt;init&gt;":()V</div><div class="line">       4: return        </div><div class="line">    LineNumberTable:</div><div class="line">      line 1: 0</div><div class="line"> </div><div class="line">  public static void increase();</div><div class="line">    Code:</div><div class="line">       0: getstatic     #2                  // Field i:I, 把i的值取到了操作栈顶,volatile保证了i值此时是正确的. </div><div class="line">       3: iconst_1      </div><div class="line">       4: iadd                              // increase,但其他线程此时可能已经把i值加大了好多</div><div class="line">       5: putstatic     #2                  // Field i:I ,把这个已经out of date的i值同步回主内存中,i值被破坏了.</div><div class="line">       8: return        </div><div class="line">    LineNumberTable:</div><div class="line">      line 6: 0</div><div class="line">      line 7: 8</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>加锁机制即可以确保原子性又可以确保可见性，而volatile变量只能确保可见性。</p>
</blockquote>
<h1 id="内置锁-synchronized"><a href="#内置锁-synchronized" class="headerlink" title="内置锁-synchronized"></a>内置锁-synchronized</h1><p>Java中最常用的同步机制就是synchronized关键字，它是一种基于语言的粗略锁，能够作用于对象、函数、Class。每个对象都只有一个锁，谁能够拿到这个锁谁就得到了访问权限。当synchronized作用于函数时，实际上锁的也是对象，锁定的对象是该函数所在类的对象。而synchronized作用于Class时则锁的是这个Class类，并非某个具体对象。</p>
<h2 id="synchronized同步方法和同步块"><a href="#synchronized同步方法和同步块" class="headerlink" title="synchronized同步方法和同步块"></a>synchronized同步方法和同步块</h2><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div></pre></td><td class="code"><pre><div class="line">public class SynchronizedDemo &#123;</div><div class="line">	</div><div class="line">	</div><div class="line">	/**</div><div class="line">	 * @param args</div><div class="line">	 */</div><div class="line">	public static void main(String[] args) &#123;</div><div class="line">		// TODO Auto-generated method stub</div><div class="line">		final Test test = new Test();</div><div class="line"></div><div class="line">		new Thread(new Runnable() &#123;</div><div class="line">			</div><div class="line">			@Override</div><div class="line">			public void run() &#123;</div><div class="line">				// TODO Auto-generated method stub</div><div class="line">				test.syncMethod(Thread.currentThread());</div><div class="line">				</div><div class="line">			&#125;</div><div class="line">		&#125;).start();</div><div class="line">		</div><div class="line">		new Thread(new Runnable() &#123;</div><div class="line">			</div><div class="line">			@Override</div><div class="line">			public void run() &#123;</div><div class="line">				// TODO Auto-generated method stub</div><div class="line">				test.syncMethod(Thread.currentThread());</div><div class="line">			&#125;</div><div class="line">		&#125;).start();</div><div class="line">		</div><div class="line">		new Thread(new Runnable() &#123;</div><div class="line">			</div><div class="line">			@Override</div><div class="line">			public void run() &#123;</div><div class="line">				// TODO Auto-generated method stub</div><div class="line">				test.asyncMethod(Thread.currentThread());</div><div class="line">			&#125;</div><div class="line">		&#125;).start();</div><div class="line">		</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class Test &#123;</div><div class="line">	</div><div class="line">	public synchronized void syncMethod(Thread thread) &#123;</div><div class="line">		for(int i = 0;i &lt; 3;i++) &#123;</div><div class="line">			System.out.println(thread.getName());</div><div class="line">			try &#123;</div><div class="line">				Thread.sleep(100);</div><div class="line">			&#125; catch (InterruptedException e) &#123;</div><div class="line">				// TODO Auto-generated catch block</div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public void asyncMethod(Thread thread) &#123;</div><div class="line">		</div><div class="line">		synchronized (this) &#123;</div><div class="line">			</div><div class="line">			for(int i = 0;i &lt; 3;i++) &#123;</div><div class="line">				System.out.println(thread.getName()+2);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">syncMethod和asyncMethod代码块都加锁时结果:</div><div class="line"></div><div class="line">Thread-0</div><div class="line">Thread-0</div><div class="line">Thread-0</div><div class="line">Thread-1</div><div class="line">Thread-1</div><div class="line">Thread-1</div><div class="line">Thread-2</div><div class="line">Thread-2</div><div class="line">Thread-2  #多个线程不能同时访问同一个对象中的synchronized锁的方法或代码块</div><div class="line"></div><div class="line">syncMethod加锁和asyncMethod代码块不加锁时结果:</div><div class="line"></div><div class="line">class Test &#123;</div><div class="line">	</div><div class="line">	public synchronized void syncMethod(Thread thread) &#123;</div><div class="line">		for(int i = 0;i &lt; 3;i++) &#123;</div><div class="line">			System.out.println(thread.getName());</div><div class="line">			try &#123;</div><div class="line">				Thread.sleep(100);</div><div class="line">			&#125; catch (InterruptedException e) &#123;</div><div class="line">				// TODO Auto-generated catch block</div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public void asyncMethod(Thread thread) &#123;</div><div class="line">		</div><div class="line">		synchronized (this) &#123;</div><div class="line">			</div><div class="line">			for(int i = 0;i &lt; 3;i++) &#123;</div><div class="line">				System.out.println(thread.getName());</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Thread-0</div><div class="line">Thread-22</div><div class="line">Thread-22</div><div class="line">Thread-22</div><div class="line">Thread-0</div><div class="line">Thread-0</div><div class="line">Thread-1</div><div class="line">Thread-1</div><div class="line">Thread-1  #其他线程可以访问同一个对象的非同步方法或代码块</div><div class="line"></div><div class="line">syncMethod不加锁和asyncMethod代码块不加锁时结果:</div><div class="line"></div><div class="line">class Test &#123;</div><div class="line">	</div><div class="line">	public void syncMethod(Thread thread) &#123;</div><div class="line">		for(int i = 0;i &lt; 3;i++) &#123;</div><div class="line">			System.out.println(thread.getName());</div><div class="line">			try &#123;</div><div class="line">				Thread.sleep(100);</div><div class="line">			&#125; catch (InterruptedException e) &#123;</div><div class="line">				// TODO Auto-generated catch block</div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	public void asyncMethod(Thread thread) &#123;</div><div class="line">		</div><div class="line">			for(int i = 0;i &lt; 3;i++) &#123;</div><div class="line">				System.out.println(thread.getName()+2);</div><div class="line">			&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Thread-0</div><div class="line">Thread-1</div><div class="line">Thread-22</div><div class="line">Thread-22</div><div class="line">Thread-22</div><div class="line">Thread-0</div><div class="line">Thread-1</div><div class="line">Thread-1</div><div class="line">Thread-0</div></pre></td></tr></table></figure>
<p>synchronized同步方法和同步块锁定的是引用对象，synchronized作用于引用对象是防止其他线程访问同一个对象的synchronized代码块或方法，但可以访问其他非同步代码块或方法。</p>
<h2 id="synchronized同步Class对象和静态方法"><a href="#synchronized同步Class对象和静态方法" class="headerlink" title="synchronized同步Class对象和静态方法"></a>synchronized同步Class对象和静态方法</h2><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div></pre></td><td class="code"><pre><div class="line">public class SynchronizedDemo &#123;</div><div class="line"></div><div class="line">	/**</div><div class="line">	 * @param args</div><div class="line">	 */</div><div class="line">	public static void main(String[] args) &#123;</div><div class="line">		// TODO Auto-generated method stub</div><div class="line">		final Test test = new Test();</div><div class="line"></div><div class="line">		new Thread(new Runnable() &#123;</div><div class="line"></div><div class="line">			@Override</div><div class="line">			public void run() &#123;</div><div class="line">				// TODO Auto-generated method stub</div><div class="line">				Test.syncStaticMethod(Thread.currentThread());</div><div class="line"></div><div class="line">			&#125;</div><div class="line">		&#125;).start();</div><div class="line"></div><div class="line">		new Thread(new Runnable() &#123;</div><div class="line"></div><div class="line">			@Override</div><div class="line">			public void run() &#123;</div><div class="line">				// TODO Auto-generated method stub</div><div class="line">				Test.syncStaticMethod(Thread.currentThread());</div><div class="line">			&#125;</div><div class="line">		&#125;).start();</div><div class="line"></div><div class="line">		new Thread(new Runnable() &#123;</div><div class="line"></div><div class="line">			@Override</div><div class="line">			public void run() &#123;</div><div class="line">				// TODO Auto-generated method stub</div><div class="line">				Test.asyncStaticMethod(Thread.currentThread());</div><div class="line">			&#125;</div><div class="line">		&#125;).start();</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class Test &#123;</div><div class="line"></div><div class="line">	public synchronized static void syncStaticMethod(Thread thread) &#123;</div><div class="line"></div><div class="line">		for (int i = 0; i &lt; 3; i++) &#123;</div><div class="line">			System.out.println(thread.getName());</div><div class="line">			try &#123;</div><div class="line">				Thread.sleep(50);</div><div class="line">			&#125; catch (InterruptedException e) &#123;</div><div class="line">				// TODO Auto-generated catch block</div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public static void asyncStaticMethod(Thread thread) &#123;</div><div class="line"></div><div class="line">		synchronized (Test.class) &#123;</div><div class="line">			for (int i = 0; i &lt; 3; i++) &#123;</div><div class="line">				System.out.println(thread.getName() + 22);</div><div class="line">				try &#123;</div><div class="line">					Thread.sleep(50);</div><div class="line">				&#125; catch (InterruptedException e) &#123;</div><div class="line">					// TODO Auto-generated catch block</div><div class="line">					e.printStackTrace();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">syncStaticMethod和asyncStaticMethod代码块都加锁的结果:</div><div class="line"></div><div class="line">Thread-0</div><div class="line">Thread-0</div><div class="line">Thread-0</div><div class="line">Thread-222</div><div class="line">Thread-222</div><div class="line">Thread-222</div><div class="line">Thread-1</div><div class="line">Thread-1</div><div class="line">Thread-1  ##多个线程不能同时访问添加了synchronized锁的代码块和方法。</div><div class="line"></div><div class="line">syncStaticMethod加锁和asyncStaticMethod代码块不加锁的结果:</div><div class="line"></div><div class="line">class Test &#123;</div><div class="line"></div><div class="line">	public synchronized static void syncStaticMethod(Thread thread) &#123;</div><div class="line"></div><div class="line">		for (int i = 0; i &lt; 3; i++) &#123;</div><div class="line">			System.out.println(thread.getName());</div><div class="line">			try &#123;</div><div class="line">				Thread.sleep(50);</div><div class="line">			&#125; catch (InterruptedException e) &#123;</div><div class="line">				// TODO Auto-generated catch block</div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public static void asyncStaticMethod(Thread thread) &#123;</div><div class="line"></div><div class="line">			for (int i = 0; i &lt; 3; i++) &#123;</div><div class="line">				System.out.println(thread.getName() + 22);</div><div class="line">				try &#123;</div><div class="line">					Thread.sleep(50);</div><div class="line">				&#125; catch (InterruptedException e) &#123;</div><div class="line">					// TODO Auto-generated catch block</div><div class="line">					e.printStackTrace();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Thread-0</div><div class="line">Thread-222</div><div class="line">Thread-222</div><div class="line">Thread-0</div><div class="line">Thread-0</div><div class="line">Thread-222</div><div class="line">Thread-1</div><div class="line">Thread-1</div><div class="line">Thread-1 ##多个线程可以同时访问非同步的代码块和方法</div><div class="line"></div><div class="line">syncStaticMethod加锁和asyncStaticMethod代码块都不加锁的结果:</div><div class="line"></div><div class="line">class Test &#123;</div><div class="line"></div><div class="line">	public static void syncStaticMethod(Thread thread) &#123;</div><div class="line"></div><div class="line">		for (int i = 0; i &lt; 3; i++) &#123;</div><div class="line">			System.out.println(thread.getName());</div><div class="line">			try &#123;</div><div class="line">				Thread.sleep(50);</div><div class="line">			&#125; catch (InterruptedException e) &#123;</div><div class="line">				// TODO Auto-generated catch block</div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	public static void asyncStaticMethod(Thread thread) &#123;</div><div class="line"></div><div class="line">			for (int i = 0; i &lt; 3; i++) &#123;</div><div class="line">				System.out.println(thread.getName() + 22);</div><div class="line">				try &#123;</div><div class="line">					Thread.sleep(50);</div><div class="line">				&#125; catch (InterruptedException e) &#123;</div><div class="line">					// TODO Auto-generated catch block</div><div class="line">					e.printStackTrace();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">Thread-0</div><div class="line">Thread-1</div><div class="line">Thread-222</div><div class="line">Thread-1</div><div class="line">Thread-0</div><div class="line">Thread-222</div><div class="line">Thread-1</div><div class="line">Thread-0</div><div class="line">Thread-222</div></pre></td></tr></table></figure>
<p>synchronized同步Class对象和静态方法锁的是Class对象，它的作用是防止多个线程同时访问添加了synchronized锁的代码块和方法。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ul>
<li><p>当一个线程正在访问一个对象的synchronized方法，那么其他线程不能访问该对象的其他synchronized方法，因为一个对象只有一把锁，当一个线程获取了该对象的锁之后，其他线程无法获取该对象的锁，所有无法访问该对象的其他synchronized方法。</p>
</li>
<li><p>当一个线程正在访问一个对象的synchronized方法，那么其他线程能访问该对象的非synchronized方法。因为非synchronized方法不需要获取该对象的锁。</p>
</li>
<li><p>如果一个线程A需要访问对象object1的synchronized方法fun1，另外一个线程B需要访问对象object2的synchronized方法fun1，即使object1和object2是同一类型，也不会产生线程安全问题，因为他们访问的是不同的对象，所以不存在互斥问题。</p>
</li>
<li><p>如果一个线程执行一个对象的非static synchronized方法，另一个线程执行这个对象所属类的static synchronized方法，此时不会发生互斥现象，因为访问static synchronized方法占用的是类锁，而访问非static synchronized方法占用的是对象锁，所以不存在互斥现象。</p>
</li>
</ul>
<p>需要注意的是：对于synchronized方法或者synchronized代码块，当出现异常时，JVM会自动释放当前线程占用的锁，因此不会由于异常导致出现死锁现象。</p>
<h1 id="显示锁-ReentrantLock与Condition"><a href="#显示锁-ReentrantLock与Condition" class="headerlink" title="显示锁-ReentrantLock与Condition"></a>显示锁-ReentrantLock与Condition</h1><h2 id="ReentrantLock"><a href="#ReentrantLock" class="headerlink" title="ReentrantLock"></a>ReentrantLock</h2><p>在JDk 5.0之前，协调共享对象的访问时，只有synchronized和volatile。Java 6.0增加了一种新的机制：ReentrantLock。显示锁ReentrantLock和内置锁synchronized相比，实现了相同的语义，但是具有更高的灵活性。</p>
<p>内置锁synchronized的获取和释放都在同一个代码块中，而显示锁ReentrantLock则可以将锁的获得和释放分开。同时显示锁可以提供轮训锁和定时锁，同时可以提供公平锁或者非公平锁。</p>
<p>ReentrantLock的基本操作如下：</p>
<table>
<thead>
<tr>
<th>函   数</th>
<th>作   用</th>
</tr>
</thead>
<tbody>
<tr>
<td>lock()</td>
<td>获取锁</td>
</tr>
<tr>
<td>tryLock()</td>
<td>尝试获取锁</td>
</tr>
<tr>
<td>tryLock(timeout,Timeunit unit)</td>
<td>在指定时间内尝试获取锁</td>
</tr>
<tr>
<td>unLock()</td>
<td>释放锁</td>
</tr>
<tr>
<td>newCondition</td>
<td>获取锁的Condition</td>
</tr>
</tbody>
</table>
<p>使用ReentrantLock的一般是lock、tryLock与unLock成对出现，需要注意的是，千万不要忘记调用unLock来释放锁，否则会引发死锁等问题。</p>
<p>ReentrantLock的常用形式如下所示：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">Lock lock = <span class="keyword">new</span> ReentrantLock();</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">	lock.lock();</div><div class="line"></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">		<span class="comment">//执行任务</span></div><div class="line"></div><div class="line">	&#125; <span class="keyword">finally</span> &#123;</div><div class="line"></div><div class="line">		lock.unlock();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<blockquote>
<p>需要注意的是，lock必须在finally块中释放，否则，如果受保护的代码块抛出异常，锁就有可能永远得不到释放。而使用synchronized同步，JVM将确保锁会获得自动释放，这也是Lock没有完全替代掉synchronized的原因。</p>
</blockquote>
<p>当JVM用synchronized管理锁定请求和释放行为时，JVM在生成线程转储时能够包括锁定信息，这些对调式有非常大的价值，因为它们能标识死锁和其他异常行为的来源。Lock类只是普通的类，JVM不知道具体哪个线程拥有Lock对象。</p>
<h2 id="Condition"><a href="#Condition" class="headerlink" title="Condition"></a>Condition</h2><p>在ReentrantLock类中有一个重要的函数newCondition()，该函数用于获取lock上的一个条件，也就是说Condition是和Lock绑定的。Condition用于实现线程间的通信，它是为了解决Object.wait()、notify()、notifyAll()难以使用的问题。</p>
<p>Condition的基本操作如下所示：</p>
<table>
<thead>
<tr>
<th>方  法</th>
<th>作  用</th>
</tr>
</thead>
<tbody>
<tr>
<td>await()</td>
<td>线程等待</td>
</tr>
<tr>
<td>await(int time,TimeUnit unit)</td>
<td>线程等待特定的时间，超过时间则为超时</td>
</tr>
<tr>
<td>signal()</td>
<td>随机唤醒某个等待线程</td>
</tr>
<tr>
<td>signalAll()</td>
<td>唤醒所有等待中的线程</td>
</tr>
</tbody>
</table>
<h2 id="综合应用"><a href="#综合应用" class="headerlink" title="综合应用"></a>综合应用</h2><p>下面通过ReentrantLock和Condition类实现一个简单的阻塞队列。如果调用take方法时集合中没有数据，那么调用线程阻塞；如果调用put方法时，集合数据已满则调用线程阻塞。但是这两个阻塞条件是不同的，分别为notFull和notEmpty。MyArrayBlockingQueue的实现代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyArrayBlockingQueue</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">// 数据数组</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> T[] items;</div><div class="line">	<span class="comment">// 锁</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">final</span> Lock mLock = <span class="keyword">new</span> ReentrantLock();</div><div class="line">	<span class="comment">// 数组满的条件</span></div><div class="line">	<span class="keyword">private</span> Condition notFull = mLock.newCondition();</div><div class="line">	<span class="comment">// 数组空的条件</span></div><div class="line">	<span class="keyword">private</span> Condition notEmpty = mLock.newCondition();</div><div class="line"></div><div class="line">	<span class="comment">// 头部</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> head;</div><div class="line">	<span class="comment">// 尾部</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> tail;</div><div class="line">	<span class="comment">// 数据数量</span></div><div class="line">	<span class="keyword">private</span> <span class="keyword">int</span> count;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MyArrayBlockingQueue</span><span class="params">(<span class="keyword">int</span> maxSize)</span> </span>&#123;</div><div class="line">		<span class="comment">// TODO Auto-generated constructor stub</span></div><div class="line">		items = (T[]) <span class="keyword">new</span> Object[maxSize];</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">MyArrayBlockingQueue</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="comment">// TODO Auto-generated constructor stub</span></div><div class="line">		<span class="keyword">this</span>(<span class="number">10</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(T t)</span> </span>&#123;</div><div class="line"></div><div class="line">		mLock.lock();</div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">			<span class="comment">// 如果数据已满,等待</span></div><div class="line">			<span class="keyword">while</span> (count == getCapacity()) &#123;</div><div class="line">				System.out.println(<span class="string">"数据已满，请等待"</span>);</div><div class="line">				notFull.await();</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			System.out.println(<span class="string">"存入数据"</span>);</div><div class="line"></div><div class="line">			items[tail] = t;</div><div class="line">			<span class="keyword">if</span> (++tail == getCapacity()) &#123;</div><div class="line">				tail = <span class="number">0</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			++count;</div><div class="line">			<span class="comment">// 唤醒等待数据的线程</span></div><div class="line">			notEmpty.signalAll();</div><div class="line"></div><div class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">			<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">			e.printStackTrace();</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			mLock.unlock();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> T <span class="title">take</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">		mLock.lock();</div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">			<span class="comment">// 如果数组数据为空，则阻塞</span></div><div class="line">			<span class="keyword">while</span> (count == <span class="number">0</span>) &#123;</div><div class="line">				System.out.println(<span class="string">"还没有数据，等待"</span>);</div><div class="line">				notEmpty.await();</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			System.out.println(<span class="string">"取出数据"</span>);</div><div class="line"></div><div class="line">			T t = items[head];</div><div class="line">			items[head] = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (++head == getCapacity()) &#123;</div><div class="line">				head = <span class="number">0</span>;</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			--count;</div><div class="line">			<span class="comment">// 唤醒添加数据的线程</span></div><div class="line">			notFull.signalAll();</div><div class="line">			<span class="keyword">return</span> t;</div><div class="line"></div><div class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">			<span class="comment">// <span class="doctag">TODO:</span> handle exception</span></div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			mLock.unlock();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getCapacity</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> items.length;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">size</span><span class="params">()</span> </span>&#123;</div><div class="line">		mLock.lock();</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="keyword">return</span> count;</div><div class="line">		&#125; <span class="keyword">finally</span> &#123;</div><div class="line">			mLock.unlock();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * <span class="doctag">@param</span> args</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">		<span class="keyword">final</span> MyArrayBlockingQueue&lt;String&gt; mQueue = <span class="keyword">new</span> MyArrayBlockingQueue&lt;&gt;(</div><div class="line">				<span class="number">5</span>);</div><div class="line"></div><div class="line">		<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">				<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line"></div><div class="line">					<span class="keyword">for</span>(<span class="keyword">int</span> i  = <span class="number">0</span>;i &lt; <span class="number">3</span>;i++)</div><div class="line">					mQueue.put(<span class="string">"just"</span>);</div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						Thread.sleep(<span class="number">50</span>);</div><div class="line">					&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">						<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">						e.printStackTrace();</div><div class="line">					&#125;</div><div class="line"></div><div class="line">				&#125;</div><div class="line"></div><div class="line">			&#125;</div><div class="line">		&#125;).start();</div><div class="line"></div><div class="line">		<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">				<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">					</div><div class="line">					mQueue.take();</div><div class="line"></div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;).start();</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">结果打印</div><div class="line">存入数据</div><div class="line">存入数据</div><div class="line">存入数据</div><div class="line">取出数据</div><div class="line">取出数据</div><div class="line">取出数据</div><div class="line">还没有数据，等待</div><div class="line">存入数据</div><div class="line">存入数据</div><div class="line">存入数据</div><div class="line">取出数据</div><div class="line">取出数据</div><div class="line">取出数据</div><div class="line">还没有数据，等待</div></pre></td></tr></table></figure>
<h1 id="信号量-Semaphore"><a href="#信号量-Semaphore" class="headerlink" title="信号量-Semaphore"></a>信号量-Semaphore</h1><p>Semaphore是一个计数信号量，它的本质是一个“共享锁”。信号量维护一个信号许可集合，线程可以通过调用acquire()来获取信号量的许可。当信号量有可用的许可时，线程能获取该许可；否则线程必须等到，直到有可用的许可为止。线程可以通过release()来释放它所持有的信号量许可。</p>
<p>Semaphore实现的功能类似食堂窗口。例如，食堂只有3个销售窗口，要吃饭的有5个人，那么同时只有3个人买饭菜，每个人占用一个窗口，另外2人只能等待。当前3个人有人离开之后，后续的人才可以占用窗口进行购买。这里的窗口就是我们所说的许可集，这里为3.一个人占用窗口时相当于他调用acquire()获取了许可，当他离开时也就等于调用release()释放了许可，这样后续的人才可以得到许可。下面看看具体的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SemaphoreTest</span> </span>&#123;</div><div class="line">	</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * <span class="doctag">@param</span> args</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">		ExecutorService service = Executors.newFixedThreadPool(<span class="number">3</span>);</div><div class="line">		<span class="keyword">final</span> Semaphore semaphore = <span class="keyword">new</span> Semaphore(<span class="number">3</span>);</div><div class="line">		</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; <span class="number">5</span>;i++) &#123;</div><div class="line">			</div><div class="line">			service.submit(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">				</div><div class="line">				<span class="meta">@Override</span></div><div class="line">				<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">					<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">					<span class="keyword">try</span> &#123;</div><div class="line">						semaphore.acquire();</div><div class="line">						System.out.println(<span class="string">"剩余许可: "</span> + semaphore.availablePermits());</div><div class="line">						Thread.sleep(<span class="number">2000</span>);</div><div class="line">						semaphore.release();</div><div class="line">						</div><div class="line">					&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">						<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">						e.printStackTrace();</div><div class="line">					&#125;</div><div class="line">					</div><div class="line">				&#125;</div><div class="line">			&#125;);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">结果打印：</div><div class="line"></div><div class="line">剩余许可: <span class="number">0</span></div><div class="line">剩余许可: <span class="number">0</span></div><div class="line">剩余许可: <span class="number">0</span></div><div class="line"></div><div class="line">剩余许可: <span class="number">2</span></div><div class="line">剩余许可: <span class="number">1</span></div></pre></td></tr></table></figure>
<p>上述结果中：前三行是立刻输出的，后两行是等待2秒之后才输出。原因是，信号量的许可集是3个，而消费线程是5个。前3个线程获取了许可之后，信号量的许可就为0。此时后面的线程再调用acquire()就会阻塞，直到前3个线程执行完之后，释放了许可（不需要同时释放许可）后两个线程才能获取许可并且继续执行。</p>
<h1 id="循环栅栏-CyclicBarrier"><a href="#循环栅栏-CyclicBarrier" class="headerlink" title="循环栅栏-CyclicBarrier"></a>循环栅栏-CyclicBarrier</h1><p>CyclicBarrier是一个同步辅助类，允许一组线程互相等待，直到达到某个公共屏障点。因为该barrier在释放等待线程后可以重用，所有称为循环的barrier。</p>
<p>下面看看示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CyclicBarrierTest</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SIZE = <span class="number">5</span>;</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> CyclicBarrier mCyclicBarrier;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * <span class="doctag">@param</span> args</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line"></div><div class="line">		mCyclicBarrier = <span class="keyword">new</span> CyclicBarrier(SIZE, <span class="keyword">new</span> Runnable() &#123;</div><div class="line">			</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">				System.out.println(<span class="string">"--满足条件执行特定操作，参与者： "</span>+ mCyclicBarrier.getParties());</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		</div><div class="line">		</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; SIZE;i++) &#123;</div><div class="line">			<span class="keyword">new</span> WorkerThread().start();</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkerThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">		</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				System.out.println(Thread.currentThread().getName() + <span class="string">"等待CyclicBarrier"</span>);</div><div class="line">				<span class="comment">//将mCyclicBarrier的参与者数量加1</span></div><div class="line">				mCyclicBarrier.await();</div><div class="line">				<span class="comment">//mCyclicBarrier的参与者数量加5时，才继续往后执行</span></div><div class="line">				System.out.println(Thread.currentThread().getName()+<span class="string">"继续执行"</span>);</div><div class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">				<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">				e.printStackTrace();</div><div class="line">			&#125; <span class="keyword">catch</span> (BrokenBarrierException e) &#123;</div><div class="line">				<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">结果打印：</div><div class="line"></div><div class="line">Thread-<span class="number">1</span>等待CyclicBarrier</div><div class="line">Thread-<span class="number">0</span>等待CyclicBarrier</div><div class="line">Thread-<span class="number">2</span>等待CyclicBarrier</div><div class="line">Thread-<span class="number">3</span>等待CyclicBarrier</div><div class="line">Thread-<span class="number">4</span>等待CyclicBarrier</div><div class="line">--满足条件执行特定操作，参与者： <span class="number">5</span></div><div class="line">Thread-<span class="number">4</span>继续执行</div><div class="line">Thread-<span class="number">3</span>继续执行</div><div class="line">Thread-<span class="number">2</span>继续执行</div><div class="line">Thread-<span class="number">0</span>继续执行</div><div class="line">Thread-<span class="number">1</span>继续执行</div></pre></td></tr></table></figure>
<p>从结果可以看出，只有当有5个线程调用了mCyclicBarrier.await()方法后，后续的任务才会继续执行。上述例子中的5个WorkThread就位之后首先会执行一个Runnable，也就是CyclicBarrier构造函数的第二个参数，该参数也可以省略。执行该Runnable之后才会继续执行下面的任务。CyclicBarrier实际上相当于可以用于多个线程等待，直到某个条件被满足后开始继续执行后续的任务。对于该示例来说，这里的条件也就是有指定个数的线程调用了mCyclicBarrier.await()方法。</p>
<h1 id="闭锁-CountDownLatch"><a href="#闭锁-CountDownLatch" class="headerlink" title="闭锁-CountDownLatch"></a>闭锁-CountDownLatch</h1><p>CountDownLatch是一个同步辅助类，在完成一组正在其他线程中执行的操作之前，它允许一个或多个线程一直等待，直到条件被满足。</p>
<p>示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CountDownLatchTest</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> LATCH_SIZE = <span class="number">5</span>;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * <span class="doctag">@param</span> args</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			</div><div class="line">			CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(LATCH_SIZE);</div><div class="line">			</div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; LATCH_SIZE;i++) &#123;</div><div class="line">				<span class="keyword">new</span> WorkerThread(countDownLatch).start();</div><div class="line">			&#125;</div><div class="line">	</div><div class="line">			System.out.println(<span class="string">"主线程等待"</span>);</div><div class="line">			</div><div class="line">			countDownLatch.await();</div><div class="line">			</div><div class="line">			System.out.println(<span class="string">"主线程继续执行"</span>);</div><div class="line">			</div><div class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">			<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WorkerThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">		</div><div class="line">		<span class="keyword">private</span> CountDownLatch latch;</div><div class="line">		</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="title">WorkerThread</span><span class="params">(CountDownLatch latch)</span> </span>&#123;</div><div class="line">			<span class="keyword">this</span>.latch = latch;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				Thread.sleep(<span class="number">1000</span>);</div><div class="line">				System.out.println(Thread.currentThread().getName() + <span class="string">"执行操作"</span>);</div><div class="line">				<span class="comment">//将latch的数量减1</span></div><div class="line">				latch.countDown();</div><div class="line">				</div><div class="line">			&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">				<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">结果打印：</div><div class="line"></div><div class="line">主线程等待</div><div class="line">Thread-<span class="number">3</span>执行操作</div><div class="line">Thread-<span class="number">1</span>执行操作</div><div class="line">Thread-<span class="number">0</span>执行操作</div><div class="line">Thread-<span class="number">4</span>执行操作</div><div class="line">Thread-<span class="number">2</span>执行操作</div><div class="line">主线程继续执行</div></pre></td></tr></table></figure>
<p>5个WorkThread对象在执行完操作之后会调用CountDownLatch的countDown()函数，当5个WorkThread全都调用了countDown()之后主线程就会被唤醒继续执行任务。</p>
<h1 id="CountDownLatch与CyclicBarrier区别"><a href="#CountDownLatch与CyclicBarrier区别" class="headerlink" title="CountDownLatch与CyclicBarrier区别"></a>CountDownLatch与CyclicBarrier区别</h1><ul>
<li><p>CountDownLatch的作用是允许1或者多个线程等待其他线程完成执行，而CyclicBarrier则是允许N个线程相互等待。</p>
</li>
<li><p>CountDownLatch的计数器无法被重置，CyclicBarrier的计数器可以被重置后使用。</p>
</li>
</ul>

    

        <a href="/2015/12/26/Java并发编程之线程同步/" class="post-more waves-effect waves-button">
            阅读全文...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/并发编程/">并发编程</a></li></ul>

    </div>
    
</article>

        </li>
    
        <li class="post-list-item fade">
            <article id="post-Java并发编程之多线程和线程池"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time datetime="2015-12-26T13:04:06.000Z" itemprop="datePublished" class="post-time">
  2015-12-26 21:04:06
</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Java/">Java</a></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2015/12/26/Java并发编程之多线程和线程池/">Java并发编程之多线程和线程池</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent" >

    
        <p>线程允许在同一个进程中同时存在多个程序控制流，即通过线程可以实现同时处理多个任务的功能。线程会共享进程范围内的资源，例如内存句柄和文件句柄，但每个线程都有各自的程序计数器、栈以及局部变量。</p>
<h1 id="多线程的实现"><a href="#多线程的实现" class="headerlink" title="多线程的实现"></a>多线程的实现</h1><h2 id="实现方式"><a href="#实现方式" class="headerlink" title="实现方式"></a>实现方式</h2><p>对于Java的多线程来说，我们学习的一般都是Thread和Runnable，通过我们使用如下代码启动一个新的线程：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startewThread</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">new</span> Thread()&#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">			<span class="comment">// 耗时任务</span></div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;.start();</div><div class="line">&#125;</div><div class="line">或者</div><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startewThread1</span><span class="params">()</span></span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="comment">// 耗时任务</span></div><div class="line"></div><div class="line">		&#125;</div><div class="line">	&#125;).start();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>第一种是覆写了Thread类中的run方法执行任务；第二种是实现Runnable接口中的run方法执行任务。</p>
<p>那么Thread和Runnable是什么关系呢？</p>
<h2 id="Thread和Runnable的关系"><a href="#Thread和Runnable的关系" class="headerlink" title="Thread和Runnable的关系"></a>Thread和Runnable的关系</h2><p>实际上Thread也是一个Runnable，它实现了Runnable接口，在Thread类中有一个Runnable类型的target字段，代表要被执行在这个子线程的任务。相关代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Thread</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">//要执行的目标任务</span></div><div class="line">    <span class="keyword">private</span> Runnable target;</div><div class="line">	<span class="comment">//线程所属的线程组</span></div><div class="line">    <span class="keyword">private</span> ThreadGroup group;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="title">Thread</span><span class="params">()</span> </span>&#123;</div><div class="line">		init(<span class="keyword">null</span>, <span class="keyword">null</span>, <span class="string">"Thread-"</span> + nextThreadNum(), <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Thread</span><span class="params">(Runnable target)</span> </span>&#123;</div><div class="line">        init(<span class="keyword">null</span>, target, <span class="string">"Thread-"</span> + nextThreadNum(), <span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ThreadGroup g, Runnable target, String name,</span></span></div><div class="line">                      <span class="keyword">long</span> stackSize, AccessControlContext acc) &#123;</div><div class="line">        <span class="keyword">if</span> (name == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">"name cannot be null"</span>);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.name = name.toCharArray();</div><div class="line"></div><div class="line">        Thread parent = currentThread();</div><div class="line">        SecurityManager security = System.getSecurityManager();</div><div class="line">        <span class="keyword">if</span> (g == <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="comment">/* Determine if it's an applet or not */</span></div><div class="line"></div><div class="line">            <span class="comment">/* If there is a security manager, ask the security manager</span></div><div class="line">               what to do. */</div><div class="line">            <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</div><div class="line">                g = security.getThreadGroup();</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            /group为<span class="keyword">null</span>则获取当前线程的线程组</div><div class="line">               use the parent thread group. */</div><div class="line">            <span class="keyword">if</span> (g == <span class="keyword">null</span>) &#123;</div><div class="line">                g = parent.getThreadGroup();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="comment">/* checkAccess regardless of whether or not threadgroup is</span></div><div class="line">           explicitly passed in. */</div><div class="line">        g.checkAccess();</div><div class="line"></div><div class="line">        <span class="comment">/*</span></div><div class="line">         * Do we have the required permissions?</div><div class="line">         */</div><div class="line">        <span class="keyword">if</span> (security != <span class="keyword">null</span>) &#123;</div><div class="line">            <span class="keyword">if</span> (isCCLOverridden(getClass())) &#123;</div><div class="line">                security.checkPermission(SUBCLASS_IMPLEMENTATION_PERMISSION);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        g.addUnstarted();</div><div class="line"></div><div class="line">        <span class="keyword">this</span>.group = g;</div><div class="line">        <span class="keyword">this</span>.daemon = parent.isDaemon();</div><div class="line">        <span class="keyword">this</span>.priority = parent.getPriority();</div><div class="line">        <span class="keyword">if</span> (security == <span class="keyword">null</span> || isCCLOverridden(parent.getClass()))</div><div class="line">            <span class="keyword">this</span>.contextClassLoader = parent.getContextClassLoader();</div><div class="line">        <span class="keyword">else</span></div><div class="line">            <span class="keyword">this</span>.contextClassLoader = parent.contextClassLoader;</div><div class="line">        <span class="keyword">this</span>.inheritedAccessControlContext =</div><div class="line">                acc != <span class="keyword">null</span> ? acc : AccessController.getContext();</div><div class="line">		<span class="comment">//设置target</span></div><div class="line">        <span class="keyword">this</span>.target = target;</div><div class="line">        setPriority(priority);</div><div class="line">        <span class="keyword">if</span> (parent.inheritableThreadLocals != <span class="keyword">null</span>)</div><div class="line">            <span class="keyword">this</span>.inheritableThreadLocals =</div><div class="line">                ThreadLocal.createInheritedMap(parent.inheritableThreadLocals);</div><div class="line">        <span class="comment">/* Stash the specified stack size in case the VM cares */</span></div><div class="line">        <span class="keyword">this</span>.stackSize = stackSize;</div><div class="line"></div><div class="line">        <span class="comment">/* Set thread ID */</span></div><div class="line">        tid = nextThreadID();</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="comment">/**</span></div><div class="line">         * This method is not invoked for the main method thread or "system"</div><div class="line">         * group threads created/set up by the VM. Any new functionality added</div><div class="line">         * to this method in the future may have to also be added to the VM.</div><div class="line">         *</div><div class="line">         * A zero status value corresponds to state "NEW".</div><div class="line">         */</div><div class="line">        <span class="keyword">if</span> (threadStatus != <span class="number">0</span>)</div><div class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalThreadStateException();</div><div class="line"></div><div class="line">        <span class="comment">/* Notify the group that this thread is about to be started</span></div><div class="line">         * so that it can be added to the group's list of threads</div><div class="line">         * and the group's unstarted count can be decremented. */</div><div class="line">        group.add(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">        <span class="keyword">boolean</span> started = <span class="keyword">false</span>;</div><div class="line">        <span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">//调用native函数启动线程</span></div><div class="line">            start0();</div><div class="line">            started = <span class="keyword">true</span>;</div><div class="line">        &#125; <span class="keyword">finally</span> &#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">if</span> (!started) &#123;</div><div class="line">                    group.threadStartFailed(<span class="keyword">this</span>);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (Throwable ignore) &#123;</div><div class="line">                <span class="comment">/* do nothing. If start0 threw a Throwable then</span></div><div class="line">                  it will be passed up the call stack */</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">	</div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">if</span> (target != <span class="keyword">null</span>) &#123;</div><div class="line">            target.run();</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>实际上最终被线程执行的任务是Runnable，而非Thread。Thread 只是对Runnable的包装，并且通过一些状态对Thread进行管理和调度。Runnable的声明如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>当启动一个线程时，如果Thread的target不为空，则会在子线程中执行这个target的run方法，否则虚拟机就会执行该线程自身的run方法。</p>
<h1 id="线程的wait、sleep、join和yield"><a href="#线程的wait、sleep、join和yield" class="headerlink" title="线程的wait、sleep、join和yield"></a>线程的wait、sleep、join和yield</h1><p>先通过下面的表格来了解他们的区别：</p>
<table>
<thead>
<tr>
<th>函数名</th>
<th>作用</th>
</tr>
</thead>
<tbody>
<tr>
<td>wait</td>
<td>当一个线程执行到wait()方法时，它就进入到一个和该对象相关的等待池中，同时释放了对象的锁，使得其他线程可以访问。用户可以使用notify、notifyAll或指定睡眠时间来唤醒当前等待池中的线程。  注意：wait、notify、notifyAll方法必须放在synchronized block中，否则则会抛出异常。</td>
</tr>
<tr>
<td>sleep</td>
<td>该函数时Thread的静态函数，作用是使调用线程进入睡眠状态。因为sleep()Thread的静态函数，因此它不能改变对象的锁。所以当一个synchronized块中调用sleep方法时，线程虽然休眠了，但是对象的锁并没有被释放，其他线程无法访问这个对象（即使睡着也持有对象锁）</td>
</tr>
<tr>
<td>join</td>
<td>等待目标线程执行完成之后再继续执行</td>
</tr>
<tr>
<td>yield</td>
<td>线程礼让。目标线程由运行状态转换为就绪状态，也就是让出执行权限，让其他线程得以优先执行，但其他线程能否优先执行时未知的。</td>
</tr>
</tbody>
</table>
<h2 id="wait"><a href="#wait" class="headerlink" title="wait()"></a>wait()</h2><p>下面来看看wait、notify、notifyAll的使用：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WaitDemo</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> Object lockObject = <span class="keyword">new</span> Object();</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">waitAndNotifAll</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">		System.out.println(<span class="string">"主线程运行"</span>);</div><div class="line"></div><div class="line">		<span class="comment">//创建并启动子线程</span></div><div class="line">		Thread thread = <span class="keyword">new</span> WaitThread();</div><div class="line">		thread.start();</div><div class="line"></div><div class="line">		<span class="keyword">long</span> startTime = System.currentTimeMillis();</div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">//必须在synchronized块中</span></div><div class="line">			<span class="keyword">synchronized</span> (lockObject) &#123;</div><div class="line">				System.out.println(<span class="string">"主线程等待"</span>);</div><div class="line">				lockObject.wait();</div><div class="line"></div><div class="line">			&#125;</div><div class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">			<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		<span class="comment">//被唤醒后继续执行</span></div><div class="line">		<span class="keyword">long</span> endTime = System.currentTimeMillis() - startTime;</div><div class="line">		</div><div class="line">		System.out.println(<span class="string">"主线程继续---&gt;等待耗时： "</span> + endTime + <span class="string">"ms"</span>);</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">WaitThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">			<span class="keyword">synchronized</span> (lockObject) &#123;</div><div class="line">				<span class="keyword">try</span> &#123;</div><div class="line">					Thread.sleep(<span class="number">3000</span>);</div><div class="line">					<span class="comment">//唤醒正在等待中的线程</span></div><div class="line">					lockObject.notifyAll();</div><div class="line">				&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">					<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">					e.printStackTrace();</div><div class="line">				&#125;</div><div class="line"></div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * <span class="doctag">@param</span> args</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">		waitAndNotifAll();</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">运行结果：</div><div class="line"></div><div class="line">主线程运行</div><div class="line">主线程等待</div><div class="line">...</div><div class="line">...</div><div class="line"></div><div class="line">主线程继续---&gt;等待耗时： <span class="number">3001</span>ms</div></pre></td></tr></table></figure>
<p>wait、notify机制通常用于等待机制的实现，当条件未满足时调用wait进入等待状态，一旦条件满足，调用notify或notifyAll唤醒等待的线程继续执行。</p>
<h2 id="join"><a href="#join" class="headerlink" title="join()"></a>join()</h2><p>join函数的原始解释为“Block the cuurent thread(Thread.currentThread()) untile the receiver finishes its execution and dies。意思就是阻塞当前调用join函数的任务所在的线程，直到该任务执行完成后再继续执行所在线程的任务。下面我们来看看一个具体是实例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JoinDemo</span> </span>&#123;</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * <span class="doctag">@param</span> args</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line"></div><div class="line">		joinDemo();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">joinDemo</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">		System.out.println(<span class="string">"主线程开始执行"</span>);</div><div class="line">		</div><div class="line">		Worker worker1 = <span class="keyword">new</span> Worker(<span class="string">"worker-1"</span>);</div><div class="line">		Worker worker2 = <span class="keyword">new</span> Worker(<span class="string">"worker-2"</span>);</div><div class="line"></div><div class="line">		worker1.start();</div><div class="line"></div><div class="line">		System.out.println(<span class="string">"启动线程1--执行完毕"</span>);</div><div class="line"></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			<span class="comment">//等待worker1任务执行完成</span></div><div class="line">			worker1.join();</div><div class="line">			</div><div class="line">			System.out.println(<span class="string">"启动线程2--执行完毕"</span>);</div><div class="line">			</div><div class="line">			worker2.start();</div><div class="line">			</div><div class="line">			<span class="comment">//等待worker2任务执行完成</span></div><div class="line">			worker2.join();</div><div class="line">			</div><div class="line">			</div><div class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">			<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		System.out.println(<span class="string">"主线程继续执行"</span>);</div><div class="line">		</div><div class="line">		System.out.println(<span class="string">"主线程执行完毕"</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Worker</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line"></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="title">Worker</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">			<span class="keyword">super</span>(name);</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">			<span class="keyword">try</span> &#123;</div><div class="line">				Thread.sleep(<span class="number">3000</span>);</div><div class="line">			&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">				<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">				e.printStackTrace();</div><div class="line">			&#125;</div><div class="line"></div><div class="line">			System.out.println(<span class="string">"Work in "</span> + getName());</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">结果打印：</div><div class="line"></div><div class="line">主线程开始执行</div><div class="line">启动线程<span class="number">1</span>--执行完毕</div><div class="line">Work in worker-<span class="number">1</span></div><div class="line">启动线程<span class="number">2</span>--执行完毕</div><div class="line">Work in worker-<span class="number">2</span></div><div class="line">主线程继续执行</div><div class="line">主线程执行完毕</div></pre></td></tr></table></figure>
<p>上述代码的逻辑是主线程开始执行、启动线程1、等待线程1执行完毕、启动线程2、等待线程2执行完毕、继续执行主线程任务。</p>
<h2 id="yield"><a href="#yield" class="headerlink" title="yield()"></a>yield()</h2><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="function"><span class="keyword">void</span> <span class="title">yield</span><span class="params">()</span></span>;</div></pre></td></tr></table></figure>
<p>yield函数的官方解释是”Causes the calling Thread to yiled execution time to another Thread that is ready to run”,意思是使调用该函数的线程让出执行时间给其他已就绪状态的线程。</p>
<p>线程的执行是有时间片的，每个线程轮流占用CPU固定的时间，执行周期到了之后就让出执行权给其他线程，而yield函数的功能就是主动让出线程的执行权给其他线程，其他线程能否得到优先权就得看各个线程的状态了。下面来看看一个具体的示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">YieldDemo</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * <span class="doctag">@param</span> args</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">		YieldThread t1 = <span class="keyword">new</span> YieldThread(<span class="string">"thread-1"</span>);</div><div class="line">		YieldThread t2 = <span class="keyword">new</span> YieldThread(<span class="string">"thread-2"</span>);</div><div class="line">		t1.start();</div><div class="line">		t2.start();</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">	</div><div class="line">	<span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">YieldThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</div><div class="line">		</div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="title">YieldThread</span><span class="params">(String name)</span> </span>&#123;</div><div class="line">			<span class="comment">// TODO Auto-generated constructor stub</span></div><div class="line">			<span class="keyword">super</span>(name);</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">			<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>;i++) &#123;</div><div class="line">				System.out.println(<span class="keyword">this</span>.getName() + <span class="string">" ; "</span> + <span class="string">"线程优先级为： "</span> + <span class="keyword">this</span>.getPriority()+ <span class="string">"---&gt;"</span> + i);</div><div class="line">				</div><div class="line">				<span class="comment">//当i为2时 调用当前线程yield函数</span></div><div class="line">				<span class="keyword">if</span> (i== <span class="number">2</span>) &#123;</div><div class="line">					Thread.yield();</div><div class="line">				&#125;</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">打印结果：</div><div class="line"></div><div class="line">thread-<span class="number">1</span> ; 线程优先级为： <span class="number">5</span>---&gt;<span class="number">0</span></div><div class="line">thread-<span class="number">2</span> ; 线程优先级为： <span class="number">5</span>---&gt;<span class="number">0</span></div><div class="line">thread-<span class="number">2</span> ; 线程优先级为： <span class="number">5</span>---&gt;<span class="number">1</span></div><div class="line">thread-<span class="number">2</span> ; 线程优先级为： <span class="number">5</span>---&gt;<span class="number">2</span></div><div class="line">thread-<span class="number">1</span> ; 线程优先级为： <span class="number">5</span>---&gt;<span class="number">1</span></div><div class="line">thread-<span class="number">1</span> ; 线程优先级为： <span class="number">5</span>---&gt;<span class="number">2</span></div><div class="line">thread-<span class="number">2</span> ; 线程优先级为： <span class="number">5</span>---&gt;<span class="number">3</span></div><div class="line">thread-<span class="number">2</span> ; 线程优先级为： <span class="number">5</span>---&gt;<span class="number">4</span></div><div class="line">thread-<span class="number">1</span> ; 线程优先级为： <span class="number">5</span>---&gt;<span class="number">3</span></div><div class="line">thread-<span class="number">1</span> ; 线程优先级为： <span class="number">5</span>---&gt;<span class="number">4</span></div></pre></td></tr></table></figure>
<p>从结果可知，thread-2首先执行到i的值为2，此时让出执行权，thread-1得到执行权运行到i的值为2时让出执行权，thread-2得到执行权执行任务结束，然后thread-1再继续执行任务。</p>
<p>注意：yield仅在一个时间片内有效。</p>
<h2 id="Callable、Future和FutureTask"><a href="#Callable、Future和FutureTask" class="headerlink" title="Callable、Future和FutureTask"></a>Callable、Future和FutureTask</h2><p>除了Runnable之外，Java还有Callable、Future和FutureTask这几个与多线程相关的概念，与Runnable不同的是这个类型都只能运用到线程池中，而Runnable既能运用在Thread中，还能运用在线程池中。</p>
<h3 id="Callable"><a href="#Callable" class="headerlink" title="Callable"></a>Callable</h3><p>Callable与Runnable的功能大致相似不同的是Callable是一个泛型接口，它有一个泛型参数V，该接口中有一个返回值（类型为V）的Call函数，而Runnable中的run方法不能将结果返回至调用者。Callable的声明如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Callable</span>&lt;<span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Computes a result, or throws an exception if unable to do so.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@return</span> computed result</div><div class="line">     * <span class="doctag">@throws</span> Exception if unable to compute a result</div><div class="line">     */</div><div class="line">    <span class="function">V <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="Future"><a href="#Future" class="headerlink" title="Future"></a>Future</h3><p>Future为线程池制定了一个可管理的任务标准。它提供了对Runnable或者Callable任务的执行结果进行取消、查询是否完成、获取结果、设置结果操作，分别对应cancel、isDone、get、set函数。get方法会阻塞，直到任务返回结果。Future的声明如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Future</span>&lt;<span class="title">V</span>&gt; </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">//取消任务</span></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">cancel</span><span class="params">(<span class="keyword">boolean</span> mayInterruptIfRunning)</span></span>;</div><div class="line"></div><div class="line">	<span class="comment">//判断任务是否已经取消</span></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isCancelled</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">	<span class="comment">//判断任务是否已经完成</span></div><div class="line">	<span class="function"><span class="keyword">boolean</span> <span class="title">isDone</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">	<span class="comment">//获取结果，如果任务未完成则等待，直到完成，因此该函数会阻塞</span></div><div class="line">	<span class="function">V <span class="title">get</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException</span>;</div><div class="line"></div><div class="line">	<span class="comment">//获取结果，如果未完成则等待，直到返回结果或timeout，该函数会阻塞</span></div><div class="line">    <span class="function">V <span class="title">get</span><span class="params">(<span class="keyword">long</span> timeout, TimeUnit unit)</span></span></div><div class="line">    <span class="keyword">throws</span> InterruptedException, ExecutionException, TimeoutException;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="FutureTask"><a href="#FutureTask" class="headerlink" title="FutureTask"></a>FutureTask</h3><p>Future只是定义了一些规范的接口，而FutureTask则是它的实现类。FutureTask实现了<code>RunnableFuture&lt;V&gt;</code>，而RunnableFuture实现了Runnable又实现了Future<v>这两个接口，因此FutureTask同时具备他们的功能。FutureTask的代码如下：</v></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureTask</span>&lt;<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">RunnableFuture</span>&lt;<span class="title">V</span>&gt; </span>&#123;</div><div class="line">	.....</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>RunnableFuture<v>类的定义</v></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">RunnableFuture</span>&lt;<span class="title">V</span>&gt; <span class="keyword">extends</span> <span class="title">Runnable</span>, <span class="title">Future</span>&lt;<span class="title">V</span>&gt; </span>&#123;</div><div class="line">    <span class="comment">/**</span></div><div class="line">     * Sets this Future to the result of its computation</div><div class="line">     * unless it has been cancelled.</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>FutureTask像Thread那样包装Runnable那样对Runnable和<code>Callable&lt;V&gt;</code>进行包装，Runnable与Callable由构造函数注入</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">FutureTask</span><span class="params">(Callable&lt;V&gt; callable)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (callable == <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">    <span class="keyword">this</span>.callable = callable;</div><div class="line">    <span class="keyword">this</span>.state = NEW;       <span class="comment">// ensure visibility of callable</span></div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">FutureTask</span><span class="params">(Runnable runnable, V result)</span> </span>&#123;</div><div class="line">    <span class="keyword">this</span>.callable = Executors.callable(runnable, result);</div><div class="line">    <span class="keyword">this</span>.state = NEW;       <span class="comment">// ensure visibility of callable</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>从上述代码可以看出，如果注入的是Runnable则会被Executors.callable()函数转换为Callable类型，即FutureTask最终都是执行Callable类型的任务，该转换函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Callable&lt;T&gt; <span class="title">callable</span><span class="params">(Runnable task, T result)</span> </span>&#123;</div><div class="line">    <span class="keyword">if</span> (task == <span class="keyword">null</span>)</div><div class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> RunnableAdapter&lt;T&gt;(task, result);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* Runnable适配器，将Runnable转换为Callable</div><div class="line">*/</div><div class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RunnableAdapter</span>&lt;<span class="title">T</span>&gt; <span class="keyword">implements</span> <span class="title">Callable</span>&lt;<span class="title">T</span>&gt; </span>&#123;</div><div class="line">    <span class="keyword">final</span> Runnable task;</div><div class="line">    <span class="keyword">final</span> T result;</div><div class="line">    RunnableAdapter(Runnable task, T result) &#123;</div><div class="line">        <span class="keyword">this</span>.task = task;</div><div class="line">        <span class="keyword">this</span>.result = result;</div><div class="line">    &#125;</div><div class="line">    <span class="function"><span class="keyword">public</span> T <span class="title">call</span><span class="params">()</span> </span>&#123;</div><div class="line">        task.run();</div><div class="line">        <span class="keyword">return</span> result;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>由于FutureTask实现了Runnable，因此它既可以通过Thread包装来执行，也可以提交给ExecuteService来执行，并且还可以通过get()函数来获取执行结果，该函数会阻塞，直到结果返回。因此，FutureTask既是Future、Runnable，又是包装了Callable（Runnable最终也会被转换为Callable），它是这两者的合体。</p>
<p>下面示例演示Runnable、Callable、FutureTask的运用，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FutureTaskDemo</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="comment">//线程池</span></div><div class="line">	<span class="keyword">static</span> ExecutorService mExecutor = Executors.newSingleThreadExecutor();</div><div class="line">	</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 向线程池提交Runnable对象</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">taskRunnable</span><span class="params">()</span> </span>&#123;</div><div class="line">		</div><div class="line">		<span class="comment">//无返回值</span></div><div class="line">		Future&lt;?&gt; future = mExecutor.submit(<span class="keyword">new</span> Runnable() &#123;</div><div class="line">			</div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">				fibc(<span class="number">20</span>);</div><div class="line">				</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line"></div><div class="line">		System.out.println(<span class="string">"taskRunnable: "</span> + future.get());</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 向线程池提交Callable对象</div><div class="line">	 * <span class="doctag">@throws</span> ExecutionException </div><div class="line">	 * <span class="doctag">@throws</span> InterruptedException </div><div class="line">	 */	</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">taskCallable</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</div><div class="line">		</div><div class="line">		Future&lt;Integer&gt; future = mExecutor.submit(<span class="keyword">new</span> Callable&lt;Integer&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">				<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">				<span class="keyword">return</span> fibc(<span class="number">20</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		</div><div class="line">		<span class="comment">//返回值</span></div><div class="line">		Integer result = future.get();</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</div><div class="line">			System.out.println(<span class="string">"taskCallable: "</span> + result);</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 向线程池提交FutureTask对象</div><div class="line">	 * <span class="doctag">@throws</span> ExecutionException </div><div class="line">	 * <span class="doctag">@throws</span> InterruptedException </div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">taskFutureTask</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</div><div class="line">		</div><div class="line">		FutureTask&lt;Integer&gt; futureTask = <span class="keyword">new</span> FutureTask&lt;&gt;(<span class="keyword">new</span> Callable&lt;Integer&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">				<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">				<span class="keyword">return</span> fibc(<span class="number">20</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		</div><div class="line">		mExecutor.submit(futureTask);</div><div class="line">		</div><div class="line">		Integer result = futureTask.get();</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</div><div class="line">			System.out.println(<span class="string">"taskFutureTask: "</span> + result);</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * Thread包装FutureTask</div><div class="line">	 * <span class="doctag">@throws</span> InterruptedException</div><div class="line">	 * <span class="doctag">@throws</span> ExecutionException</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">taskThread</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</div><div class="line">		</div><div class="line">		FutureTask&lt;Integer&gt; futureTask = <span class="keyword">new</span> FutureTask&lt;&gt;(<span class="keyword">new</span> Callable&lt;Integer&gt;() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">				<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">				<span class="keyword">return</span> fibc(<span class="number">20</span>);</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line">		</div><div class="line">		<span class="keyword">new</span> Thread(futureTask).start();</div><div class="line">		</div><div class="line">		Integer result = futureTask.get();</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (result != <span class="keyword">null</span>) &#123;</div><div class="line">			System.out.println(<span class="string">"taskThread: "</span> + result);</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 斐波那契数列</div><div class="line">	 * <span class="doctag">@param</span> num</div><div class="line">	 * <span class="doctag">@return</span></div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">fibc</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (num == <span class="number">0</span>) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (num == <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="keyword">return</span> fibc(num - <span class="number">1</span>) + fibc(num - <span class="number">2</span>);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * <span class="doctag">@param</span> args</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			taskRunnable();</div><div class="line">			taskCallable();</div><div class="line">			taskFutureTask();</div><div class="line">			taskThread();</div><div class="line">		&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">			<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">			e.printStackTrace();</div><div class="line">		&#125; </div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">打印结果：</div><div class="line"></div><div class="line">taskRunnable: <span class="keyword">null</span></div><div class="line">taskCallable: <span class="number">6765</span></div><div class="line">taskFutureTask: <span class="number">6765</span></div><div class="line">taskThread: <span class="number">6765</span></div></pre></td></tr></table></figure>
<h1 id="线程池"><a href="#线程池" class="headerlink" title="线程池"></a>线程池</h1><p>当我们需要频繁地创建多个线程进行耗时操作时，每次都通过new Thread实现并不是一种好的方式，每次new Thread新建销毁对象性能较差，线程缺乏统一的管理，可能会无限制地创建新的线程，线程之间相互竞争从而占用过多系统资源导致死锁，并且缺乏定期执行、定时执行、线程中断等功能。</p>
<p>Java提供了4中线程池，它能够有效地管理、调度线程，避免过多的资源消耗，它强大到几乎不需要开发人员自定义的程序。它的优点如下：</p>
<ul>
<li>重用存在的线程，减少对象创建、销毁的开销；</li>
<li>可有效控制最大并发线程数，提高系统资源的使用率，同时避免过多资源竞争，避免堵塞；</li>
<li>提供定时执行、定期执行、单线程、并发数控制等功能；</li>
</ul>
<p>线程池的原理就是会创建创建多个线程并且对这些线程进行管理，提交给线程的任务 会被线程池指派给其中的线程执行，提供线程池的统一调度、管理。使得多线程的使用更简单、高效。</p>
<p>线程池都实现了ExecutorService接口，该接口定义了线程池需要实现的接口，如submit、execute、shutdown等。它的实现有ThreadPoolExecutor和ScheduledPoolExecutor，ThreadPoolExecutor是运行最多的线程池实现，ScheduledPoolExecutor则用于执行周期性任务。</p>
<h2 id="启动指定数量的线程-ThreadPoolExecutor"><a href="#启动指定数量的线程-ThreadPoolExecutor" class="headerlink" title="启动指定数量的线程-ThreadPoolExecutor"></a>启动指定数量的线程-ThreadPoolExecutor</h2><p>ThreadPoolExecutor的功能是启动指定数量的线程以及将任务添加到一个队列中，并且将任务分发给空闲的线程。</p>
<p>ExecutorService的生命周期包括3中状态：运行、关闭、终止，创建后进入运行状态，调用shutdown()方法时便进入了关闭状态，此时ExecutorService不再接受新的任务，但它继续执行完已经提交的任务，当所有已经提交的任务都执行完后，就变成终止状态。</p>
<p>ThreadPoolExecutor的构造函数如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ThreadPoolExecutor</span><span class="params">(<span class="keyword">int</span> corePoolSize,</span></span></div><div class="line">						  <span class="keyword">int</span> maximumPoolSize,</div><div class="line">						  <span class="keyword">long</span> keepAliveTime,</div><div class="line">						  TimeUnit unit,</div><div class="line">						  BlockingQueue&lt;Runnable&gt; workQueue,</div><div class="line">						  ThreadFactory threadFactory,</div><div class="line">						  RejectedExecutionHandler handler)</div></pre></td></tr></table></figure>
<p>下面对参数进行详细说明:</p>
<table>
<thead>
<tr>
<th>参 数 名</th>
<th>作  用</th>
</tr>
</thead>
<tbody>
<tr>
<td>corePoolSize</td>
<td>线程池中所保存的核心线程数。</td>
</tr>
<tr>
<td>maximumPoolSize</td>
<td>线程池所容纳的最大线程数，当活动线程达到这个数值后，后续的任务将会被阻塞</td>
</tr>
<tr>
<td>keepAliveTime</td>
<td>非核心线程闲置时的超时时间，超出这个时长，非核心线程就会被回收</td>
</tr>
<tr>
<td>unit</td>
<td>用于指定keepAliveTime参数的时间单位，有毫秒、秒、分钟等</td>
</tr>
<tr>
<td>workQueue</td>
<td>线程池中的任务队列，如果线程池的线程数量已经达到核心线程数并且当前所有线程都处于活动状态时，则将新任务放到此队列中等待执行</td>
</tr>
<tr>
<td>threadFactory</td>
<td>线程工厂，为线程池提供创建新线程的功能，通常不需要设置</td>
</tr>
<tr>
<td>handler</td>
<td>拒绝策略，当线程池与workQueue队列都满了的情况下，对新任务采取的处理策略</td>
</tr>
</tbody>
</table>
<p><a href="http://liuguoquan727.github.io/2016/04/25/Android%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0/" target="_blank" rel="external">线程池参数也可以参考这篇文章http://liuguoquan727.github.io/2016/04/25/Android%E7%9A%84%E7%BA%BF%E7%A8%8B%E5%92%8C%E7%BA%BF%E7%A8%8B%E6%B1%A0/:</a></p>
<p>其中workQueue有下列几个常用的实现：</p>
<ul>
<li>ArrayBlockingQueue</li>
</ul>
<p>基于数组结构的有界队列，此队列按FIFO原则对任务进行排序。如果队列满了还有任务进来，则调用拒绝策略</p>
<ul>
<li>LinkedBlockingQueue</li>
</ul>
<p>基于链表结构的无界队列，此队列按FIFO原则对任务进行排序。因为它是无界的，所以才有此队列后线程池将忽略handler参数。</p>
<ul>
<li>SynchronousQueue</li>
</ul>
<p>直接将任务提交给线程而不是将它加入到队列，实际上该队列是空的。每个插入的操作必须等到另一个调用移除的操作，如果新任务来了线程池没有任何可用线程处理的话，则调用拒绝策略。</p>
<ul>
<li>PriorityBlockingQueue</li>
</ul>
<p>具有优先级的队列的有界队列，可用自定义优先级，默认是按自然排序的。</p>
<p>此外，当线程池与workQueue队列都满了的情况下，对新加任务采取的处理策略也有几个默认实现：</p>
<ul>
<li>AbortPolicy</li>
</ul>
<p>拒绝任务，抛出RejectedExecutionException异常，线程池默认策略</p>
<ul>
<li>CallerRunsPolicy</li>
</ul>
<p>拒绝新任务加入，如果该线程池还没有被关闭，那么将这个新任务执行在调用线程中</p>
<ul>
<li>DiscardOldestPolicy</li>
</ul>
<p>如果执行程序还没有关闭，则将位于工作队列头部的任务删除，然后重试执行程序（如果再次失败，则重复此过程）</p>
<ul>
<li>DiscardPolicy</li>
</ul>
<p>加不进的任务都被抛弃了，同时没有异常抛出</p>
<h3 id="newFixedThreadPool"><a href="#newFixedThreadPool" class="headerlink" title="newFixedThreadPool"></a>newFixedThreadPool</h3><p>对应Android平台来说，最常使用的就是通过Executors.newFixedThreadPool(int size)函数来启动固定数量的线程池，代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExectorsDemo</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MAX = <span class="number">10</span>;</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * <span class="doctag">@param</span> args</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			fixedThreadPool(MAX);</div><div class="line">		&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</div><div class="line">			<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">			e.printStackTrace();</div><div class="line">		&#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</div><div class="line">			<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">fixedThreadPool</span><span class="params">(<span class="keyword">int</span> size)</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</div><div class="line">		</div><div class="line">		ExecutorService service = Executors.newFixedThreadPool(size);</div><div class="line">		</div><div class="line">		<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; MAX;i++) &#123;</div><div class="line">			</div><div class="line">			<span class="comment">//提交任务</span></div><div class="line">			Future&lt;Integer&gt; task = service.submit(<span class="keyword">new</span> Callable&lt;Integer&gt;() &#123;</div><div class="line"></div><div class="line">				<span class="meta">@Override</span></div><div class="line">				<span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</div><div class="line">					<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">					System.out.println(<span class="string">"执行线程: "</span> + Thread.currentThread().getName());</div><div class="line">					<span class="keyword">return</span> fibc(<span class="number">20</span>);</div><div class="line">				&#125;</div><div class="line">			&#125;);</div><div class="line">			</div><div class="line">			<span class="comment">//获取结果</span></div><div class="line">			System.out.println(<span class="string">"第"</span>+i+<span class="string">"次计算结果: "</span> + task.get());</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * 斐波那契数列</div><div class="line">	 * <span class="doctag">@param</span> num</div><div class="line">	 * <span class="doctag">@return</span></div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">fibc</span><span class="params">(<span class="keyword">int</span> num)</span> </span>&#123;</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (num == <span class="number">0</span>) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">0</span>;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="keyword">if</span> (num == <span class="number">1</span>) &#123;</div><div class="line">			<span class="keyword">return</span> <span class="number">1</span>;</div><div class="line">		&#125;</div><div class="line">		</div><div class="line">		<span class="keyword">return</span> fibc(num - <span class="number">1</span>) + fibc(num - <span class="number">2</span>);</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">结果打印：</div><div class="line"></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">1</span></div><div class="line">第<span class="number">0</span>次计算结果: <span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">2</span></div><div class="line">第<span class="number">1</span>次计算结果: <span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">3</span></div><div class="line">第<span class="number">2</span>次计算结果: <span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">1</span></div><div class="line">第<span class="number">3</span>次计算结果: <span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">2</span></div><div class="line">第<span class="number">4</span>次计算结果: <span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">3</span></div><div class="line">第<span class="number">5</span>次计算结果: <span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">1</span></div><div class="line">第<span class="number">6</span>次计算结果: <span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">2</span></div><div class="line">第<span class="number">7</span>次计算结果: <span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">3</span></div><div class="line">第<span class="number">8</span>次计算结果: <span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">1</span></div><div class="line">第<span class="number">9</span>次计算结果: <span class="number">6765</span></div></pre></td></tr></table></figure>
<p>在上述例子中，我们启动了含有3个线程的线程池，调用的是Executors的newFixedThreadPool函数，该函数的实现为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> ExecutorService <span class="title">newFixedThreadPool</span><span class="params">(<span class="keyword">int</span> nThreads)</span> </span>&#123;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ThreadPoolExecutor(nThreads, nThreads,</div><div class="line">                                  <span class="number">0L</span>, TimeUnit.MILLISECONDS,</div><div class="line">                                  <span class="keyword">new</span> LinkedBlockingQueue&lt;Runnable&gt;());</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>可知它的corePoolSize和MaxnumPoolSize值都是nThreads，并且设置keepAliveTime为0毫秒，最后设置无界任务队列，这样该线程池中就含有固定个数的线程，并且能够容纳无数个任务。</p>
<h3 id="newCacheThreadPool"><a href="#newCacheThreadPool" class="headerlink" title="newCacheThreadPool"></a>newCacheThreadPool</h3><p>有时可能需要任务尽可能快地被执行，这就需要线程池中的线程足够多也就是说此时需要拿空间来换时间，线程越多占用的内存消耗就越大。因此，我们可能需要一种场景，如果来了一个新的任务，并且没有空闲线程可用，此时必须马上创建一个线程来立即执行任务。我们可以通过Executors的newCacheThreadPool函数来实现。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">newCacheThreadPool</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, ExecutionException </span>&#123;</div><div class="line"></div><div class="line">	ExecutorService service = Executors.newCachedThreadPool();</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>;i &lt; MAX;i++) &#123;</div><div class="line"></div><div class="line">		<span class="comment">//提交任务</span></div><div class="line">		service.submit(<span class="keyword">new</span> Runnable() &#123;</div><div class="line"></div><div class="line">			<span class="meta">@Override</span></div><div class="line">			<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">				<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">				System.out.println(<span class="string">"执行线程: "</span> + Thread.currentThread().getName() + <span class="string">",结果:"</span> + fibc(<span class="number">20</span>));</div><div class="line">			&#125;</div><div class="line">		&#125;);</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line">结果打印</div><div class="line"></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">1</span>,结果:<span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">2</span>,结果:<span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">4</span>,结果:<span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">6</span>,结果:<span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">8</span>,结果:<span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">5</span>,结果:<span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">3</span>,结果:<span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">7</span>,结果:<span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">10</span>,结果:<span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">9</span>,结果:<span class="number">6765</span></div></pre></td></tr></table></figure>
<p>从上述结果可以看出，为了保证吞吐量，该线程池为每个任务都创建了一个线程，当然这是在没有线程空闲的情况下创建的新的线程。假设执行前5个任务时都创建了一个线程，执行到底6个任务时刚好前面的第一个任务执行完毕，此时线程1空闲，那么第六个任务就会被执行在第一个线程中，而不是重新创建。</p>
<h2 id="执行周期性任务的线程-ScheduledPoolExecutor"><a href="#执行周期性任务的线程-ScheduledPoolExecutor" class="headerlink" title="执行周期性任务的线程-ScheduledPoolExecutor"></a>执行周期性任务的线程-ScheduledPoolExecutor</h2><p>通过Executors的newScheduledThreadPool函数即可创建定时执行任务的线程池。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">newScheduledThreadPool</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException,</span></div><div class="line">		ExecutionException &#123;</div><div class="line"></div><div class="line">	ScheduledExecutorService service = Executors.newScheduledThreadPool(<span class="number">4</span>);</div><div class="line"></div><div class="line">	<span class="comment">// 参数2为第一次延迟的时间，参数2为执行周期</span></div><div class="line">	service.scheduleAtFixedRate((<span class="keyword">new</span> Runnable() &#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">			System.out.println(<span class="string">"执行线程: "</span> + Thread.currentThread().getName()</div><div class="line">					+ <span class="string">",定时计算 1结果:"</span> + fibc(<span class="number">20</span>));</div><div class="line">		&#125;</div><div class="line">	&#125;), <span class="number">1</span>, <span class="number">2</span>, TimeUnit.SECONDS);</div><div class="line"></div><div class="line">	<span class="comment">// 参数2为第一次延迟的时间，参数2为执行周期</span></div><div class="line">	service.scheduleAtFixedRate((<span class="keyword">new</span> Runnable() &#123;</div><div class="line"></div><div class="line">		<span class="meta">@Override</span></div><div class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">			<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">			System.out.println(<span class="string">"执行线程: "</span> + Thread.currentThread().getName()</div><div class="line">					+ <span class="string">",定时计算2结果:"</span> + fibc(<span class="number">30</span>));</div><div class="line">		&#125;</div><div class="line">	&#125;), <span class="number">1</span>, <span class="number">2</span>, TimeUnit.SECONDS);</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">打印结果：</div><div class="line"></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">1</span>,定时计算 <span class="number">1</span>结果:<span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">2</span>,定时计算<span class="number">2</span>结果:<span class="number">832040</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">1</span>,定时计算 <span class="number">1</span>结果:<span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">3</span>,定时计算<span class="number">2</span>结果:<span class="number">832040</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">1</span>,定时计算 <span class="number">1</span>结果:<span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">4</span>,定时计算<span class="number">2</span>结果:<span class="number">832040</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">1</span>,定时计算 <span class="number">1</span>结果:<span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">3</span>,定时计算<span class="number">2</span>结果:<span class="number">832040</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">2</span>,定时计算 <span class="number">1</span>结果:<span class="number">6765</span></div><div class="line">执行线程: pool-<span class="number">1</span>-thread-<span class="number">4</span>,定时计算<span class="number">2</span>结果:<span class="number">832040</span></div></pre></td></tr></table></figure>
<p>该线程池有4个线程，我们指定了两个定时任务，因此该线程池中有两个线程来定时执行任务，哪个线程空闲就调度哪个线程来执行任务。</p>
<h1 id="同步集合"><a href="#同步集合" class="headerlink" title="同步集合"></a>同步集合</h1><h2 id="程序中的优化策略-CopyOnWrite"><a href="#程序中的优化策略-CopyOnWrite" class="headerlink" title="程序中的优化策略-CopyOnWrite"></a>程序中的优化策略-CopyOnWrite</h2><p>Copy-On-Write是一种用于程序设计中的优化策略，其基本思路是，从多个线程共享同一个列表，当某个线程想要修改这个列表的元素时，会把列表中的元素复制一份，然后进行修改，修改完成之后再将新的元素设置给这个列表，这是一种延时懒惰策略。这样做的好处是我们可以对CopyOnWrite容器进行并发的读而不需要加锁，因为当前容器不会添加、移除任何元素。所有CopyOnWrite容器也是一种读写分离的思想，读和写不同的容器。从JDK1.5起Java并发包提供了两个使用CopyOnWrite机制实现的并发容器，它们是CopyOnWriteArrayList和CopyOnWriteSet。</p>
<p>通过这种写时拷贝的原理可以将读、写分离，使并发场景下对列表的操作效率得到提高，但它的缺点是，在添加、移除元素时占用的内存空间翻了一倍，因此，这是以空间换时间的策略。</p>
<h2 id="提高并发效率-ConcurrentHasMap"><a href="#提高并发效率-ConcurrentHasMap" class="headerlink" title="提高并发效率-ConcurrentHasMap"></a>提高并发效率-ConcurrentHasMap</h2><p>HashTable使用synchronized来保证线程安全，但在线程竞争激烈的情况下HashTable的效率非常低下。因为当一个线程访问HashTable同步方法时，其他线程访问HashTable的同步方法时，可能会进入阻塞或轮询状态。如线程1使用put进行添加元素，线程2不但不能使用put方法添加元素，并且也不能使用个图方法来获取元素，所以竞争越激烈效率越低。</p>
<p>HashTable在竞争激烈的并发环境下表现出效率低下的原因是因为所有访问HashTable的线程都必须竞争同一把锁。<br>假如容器里有多把锁，每一把锁用于锁容器其中一部分数据，那么当多线程访问容器里不同数据段的数据时，线程间就不会存在锁竞争，从而可以有效的提高并发访问效率，这就是ConcurrentHasMap所使用的锁分段技术，首先将数据分成一段一段的存储，然后给每一段数据配一把锁，当一个线程占用锁访问其中一个段数据的时候，其他段的数据也能被其他线程访问。有些方法需要跨段，如size()和containsValue()，它们可能需要锁定整个表而不仅是某个段，这需要按顺序锁定所有段，操作完毕后，又按顺序释放所有段的锁。</p>
<h2 id="有效的方法-BlockingQueue"><a href="#有效的方法-BlockingQueue" class="headerlink" title="有效的方法-BlockingQueue"></a>有效的方法-BlockingQueue</h2><p>BlockingQueue的重要方法:</p>
<table>
<thead>
<tr>
<th>函 数 名</th>
<th>作   用</th>
</tr>
</thead>
<tbody>
<tr>
<td>add(e)</td>
<td>把元素e添加到队列中，成功返回true，否则抛出异常</td>
</tr>
<tr>
<td>offer(e)</td>
<td>把元素e添加到队列中，成功返回true，否则返回false</td>
</tr>
<tr>
<td>offer(e,time,unit)</td>
<td>把元素e添加到队列中，成功返回true，否则在等待指定的时间之后继续尝试添加，如果失败则返回false</td>
</tr>
<tr>
<td>put(e)</td>
<td></td>
<td>把元素e添加到队列中，如果队列不能容纳，则调用此方法的线程被阻塞直到队列里面有空间再继续添加</td>
</tr>
<tr>
<td>take()</td>
<td></td>
<td>取出队列中的首个元素，若队列为空，则线程进入等待直到队列中新的元素加入为止</td>
</tr>
<tr>
<td>poll(time,unit)</td>
<td>取出并移除队列中的首个元素，如果在指定的时间内没有获取元素，则返回null</td>
</tr>
<tr>
<td>element()</td>
<td></td>
<td>获取队首元素，如果队列为null，那么抛出NoSuchElementException异常</td>
</tr>
<tr>
<td>peek()</td>
<td></td>
<td>获取队首元素，如果队列为空，那么返回null</td>
</tr>
<tr>
<td>remove()</td>
<td></td>
<td>获取并移除队首元素，如果队列为空，那么抛出NoSuchElementException异常</td>
</tr>
</tbody>
</table>
<p>BlockingQueue常用的实现有：</p>
<ul>
<li>ArrayBlockingQueue</li>
<li>LinkedBlockingQueue</li>
<li>LinkedBlockingDequeue</li>
<li>ConcurrentLinkedQueue</li>
</ul>

    

        <a href="/2015/12/26/Java并发编程之多线程和线程池/" class="post-more waves-effect waves-button">
            阅读全文...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/并发编程/">并发编程</a></li></ul>

    </div>
    
</article>

        </li>
    
        <li class="post-list-item fade">
            <article id="post-Java注解Annotation和依赖注入"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time datetime="2015-12-25T13:04:06.000Z" itemprop="datePublished" class="post-time">
  2015-12-25 21:04:06
</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Java/">Java</a></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2015/12/25/Java注解Annotation和依赖注入/">Java注解Annotation和依赖注入</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent" >

    
        <h1 id="注解"><a href="#注解" class="headerlink" title="注解"></a>注解</h1><h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>注解（Annotation），也叫元数据。一种代码级别的说明。它是JDK1.5及以后版本引入的一个特性，与类、接口、枚举是在同一个层次。它可以声明在包、类、字段、方法、局部变量、方法参数等的前面，用来对这些元素进行说明，注释。</p>
<h2 id="作用"><a href="#作用" class="headerlink" title="作用"></a>作用</h2><ul>
<li>标记作用</li>
</ul>
<p>用于告诉编译器一些信息让编译器能够实现基本的编译检查，如@Override、@Deprecated，</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(ElementType.METHOD)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.SOURCE)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Override &#123;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="meta">@Documented</span></div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Deprecated &#123;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>编译时动态处理</li>
</ul>
<p>动态生成代码，如ButterKnife、Dagger2</p>
<ul>
<li>运行时动态处理</li>
</ul>
<p>获取注解信息，如Retrofit</p>
<h2 id="分类"><a href="#分类" class="headerlink" title="分类"></a>分类</h2><h3 id="按功能分类"><a href="#按功能分类" class="headerlink" title="按功能分类"></a>按功能分类</h3><ul>
<li>标准注解</li>
</ul>
<p>是指Java自带的几个注解，Override、Deprecated、SuppressWarnings，分别表示重写方法、不推荐使用（过时的）、忽略某项Warning.</p>
<ul>
<li>元注解</li>
</ul>
<p>元注解是指用来定义注解的注解，JDK1.5定义了四种元注解：@Retention、@Target、@Inherit、@Documented。</p>
<ul>
<li>自定义注解（meta-annotation）</li>
</ul>
<p>自定义注解表示自己根据需要定义的注解，定义时需要用到上面的元注解。</p>
<h3 id="按作用域分类"><a href="#按作用域分类" class="headerlink" title="按作用域分类"></a>按作用域分类</h3><ul>
<li>源码时注解（RetentionPolicy.SOURCE）</li>
<li>编译时注解（RetentionPolicy.CLASS）</li>
<li>运行时注解（RetentionPolicy.RUNTIME）</li>
</ul>
<h2 id="注解相关知识点"><a href="#注解相关知识点" class="headerlink" title="注解相关知识点"></a>注解相关知识点</h2><h3 id="元注解知识点"><a href="#元注解知识点" class="headerlink" title="元注解知识点"></a>元注解知识点</h3><ul>
<li>@Target：指Annotation所修饰的对象范围，通过ElementType取值有8中，如下：</li>
</ul>
<table>
<thead>
<tr>
<th>取值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>TYPE</td>
<td>类、接口（包括注解类型）或枚举</td>
</tr>
<tr>
<td>FILED</td>
<td>属性</td>
</tr>
<tr>
<td>METHOD</td>
<td>方法</td>
</tr>
<tr>
<td>PARAMETER</td>
<td>参数</td>
</tr>
<tr>
<td>CONSTRUCTOR</td>
<td>构造函数</td>
</tr>
<tr>
<td>LOCAL_VARIABLE</td>
<td>局部变量</td>
</tr>
<tr>
<td>ANNOTATION_TYPE</td>
<td>注解类型</td>
</tr>
<tr>
<td>PACKAGE</td>
<td>包</td>
</tr>
</tbody>
</table>
<ul>
<li>@Retention:指Annotation被保留的时间长短，通过RetentionPolicy取值有3种，如</li>
</ul>
<table>
<thead>
<tr>
<th>值</th>
<th>含义</th>
</tr>
</thead>
<tbody>
<tr>
<td>SOURCE</td>
<td>在源文件有效，编译时就会忽略</td>
</tr>
<tr>
<td>CLASS</td>
<td>在Class文件中有效，但JVM将会忽略  如Override、SuppressWarnings等</td>
</tr>
<tr>
<td>RUNTIME</td>
<td>在运行时有效 ，所以它们能在运行时被JVM或其他使用反射机制的代码所读取和使用</td>
</tr>
</tbody>
</table>
<ul>
<li><p>@Documented：是一个标记注解，表明这个注解应该被 javadoc工具记录. 默认情况下,javadoc是不包括注解的. 但如果声明注解时指定了 @Documented,则它会被 javadoc 之类的工具处理, 所以注解类型信息也会被包括在生成的文档中.</p>
</li>
<li><p>@Inherited：也是一个标记注解，@Inherited阐述了某个被标注的类型是被继承的，默认为false</p>
</li>
</ul>
<h3 id="注解定义格式"><a href="#注解定义格式" class="headerlink" title="注解定义格式"></a>注解定义格式</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> 注解名 &#123;定义体&#125;</div></pre></td></tr></table></figure>
<h3 id="注解支持的数据类型"><a href="#注解支持的数据类型" class="headerlink" title="注解支持的数据类型"></a>注解支持的数据类型</h3><ol>
<li>8种基本数据类型 int、float、boolean、byte、double、char、long、short  </li>
<li>String、Class、enum、Annotation</li>
<li>以上所有类型的数组</li>
</ol>
<h3 id="注意"><a href="#注意" class="headerlink" title="注意"></a>注意</h3><p>自定义注解如果只有一个参数成员，最好把定义体参数名称设为”value”，如@Target</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Documented</span></div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="meta">@Target</span>(ElementType.ANNOTATION_TYPE)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Target &#123;</div><div class="line">    ElementType[] value();</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="Annotation自定义"><a href="#Annotation自定义" class="headerlink" title="Annotation自定义"></a>Annotation自定义</h2><h3 id="调用"><a href="#调用" class="headerlink" title="调用"></a>调用</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@MethodInfo</span>(</div><div class="line">        author = “trinea.cn+android<span class="meta">@gmail</span>.com”,</div><div class="line">        date = <span class="string">"2014/02/14"</span>,</div><div class="line">        version = <span class="number">2</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getAppName</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">"trinea"</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>MethodInfo Annotation作用为给方法添加相关信息，包括author、date、version</p>
<h3 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Documented</span></div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="meta">@Target</span>(ElementType.METHOD)</div><div class="line"><span class="meta">@Inherited</span></div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> MethodInfo &#123;</div><div class="line"></div><div class="line">    <span class="function">String <span class="title">author</span><span class="params">()</span> <span class="keyword">default</span> "trinea@gmail.com"</span>;</div><div class="line"></div><div class="line">    <span class="function">String <span class="title">date</span><span class="params">()</span></span>;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">int</span> <span class="title">version</span><span class="params">()</span> <span class="keyword">default</span> 1</span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面是MethondInfo的实现部分：</p>
<ol>
<li>通过@interface定义，注解名即为自定义注解名</li>
<li>注解配置参数名为注解类的方法名且<ul>
<li>所有方法没有方法体，没有参数没有修饰符，实际只允许public&amp;abstract修饰符，默认为public，不允许抛出异常</li>
<li>方法返回值只能是基本类型、String、Class、Annotation、Enum或者是它们的一维数组</li>
<li>若只有一个默认属性，可直接用value（）函数，一个属性都没有表示该 Annotation 为 Mark Annotation</li>
</ul>
</li>
<li>可以加default表示默认值</li>
</ol>
<h2 id="Annotation解析"><a href="#Annotation解析" class="headerlink" title="Annotation解析"></a>Annotation解析</h2><h3 id="运行时Annotation解析"><a href="#运行时Annotation解析" class="headerlink" title="运行时Annotation解析"></a>运行时Annotation解析</h3><p>运行时Annotation指@Retention为RUNTIME的Annotation，可手动调用下面常用API解析：</p>
<ul>
<li>method.getAnnotation(AnnotationName.class)</li>
</ul>
<p>表示得到该Target某个Annotation的信息，因为一个Target可以被多个Annotation修饰</p>
<ul>
<li>method.getAnnotations()</li>
</ul>
<p>表示得到该Target所有Annotation</p>
<ul>
<li>method.isAnnotationPresent(AnnotationName.class)</li>
</ul>
<p>表示该Target是否被某个Annotation修饰</p>
<h4 id="Target为METHOND"><a href="#Target为METHOND" class="headerlink" title="@Target为METHOND"></a>@Target为METHOND</h4><p>解析示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">App</span> </span>&#123;</div><div class="line">	</div><div class="line">    <span class="meta">@MethodInfo</span>(</div><div class="line">            author = <span class="string">"trinea.cn+android@gmail.com"</span>,</div><div class="line">            date = <span class="string">"2014/02/14"</span>,</div><div class="line">            version = <span class="number">2</span>)</div><div class="line">	<span class="function"><span class="keyword">public</span> String <span class="title">getAppName</span><span class="params">()</span> </span>&#123;</div><div class="line">		<span class="keyword">return</span> <span class="string">"trinea"</span>;</div><div class="line">	&#125;</div><div class="line">		</div><div class="line">    <span class="meta">@MethodInfo</span>(author = <span class="string">"liu.cn+android@gmail.com"</span>,</div><div class="line">            date = <span class="string">"2015/02/14"</span>,</div><div class="line">            version = <span class="number">3</span>)</div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getNewAppName</span><span class="params">()</span> </span>&#123;</div><div class="line">    	<span class="keyword">return</span> <span class="string">"liu"</span>;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * <span class="doctag">@param</span> args</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">		</div><div class="line">		<span class="keyword">try</span> &#123;</div><div class="line">			Class&lt;?&gt; clz = Class.forName(<span class="string">"com.michael.java.annotation.App"</span>);</div><div class="line">			</div><div class="line">			<span class="keyword">for</span>(Method method : clz.getMethods()) &#123;</div><div class="line">				</div><div class="line">				MethodInfo methodInfo = method.getAnnotation(MethodInfo.class);</div><div class="line">				</div><div class="line">				<span class="keyword">if</span> (methodInfo != <span class="keyword">null</span>) &#123;</div><div class="line">					System.out.println(method.getName());</div><div class="line">					System.out.println(methodInfo.author());</div><div class="line">					System.out.println(methodInfo.date());</div><div class="line">					System.out.println(methodInfo.version());</div><div class="line">					</div><div class="line">					Annotation[] annotations = method.getAnnotations();</div><div class="line">					<span class="keyword">for</span>(Annotation annotation : annotations)&#123;</div><div class="line">						System.out.println(annotation.toString());</div><div class="line">					&#125;</div><div class="line">				&#125;</div><div class="line">				</div><div class="line">			&#125;</div><div class="line">			</div><div class="line">		&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">			<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">			e.printStackTrace();</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">运行结果：</div><div class="line"></div><div class="line">getAppName</div><div class="line">trinea.cn+android<span class="meta">@gmail</span>.com</div><div class="line"><span class="number">2014</span>/<span class="number">02</span>/<span class="number">14</span></div><div class="line"><span class="number">2</span></div><div class="line"><span class="meta">@com</span>.michael.java.annotation.MethodInfo(version=<span class="number">2</span>, author=trinea.cn+android<span class="meta">@gmail</span>.com, date=<span class="number">2014</span>/<span class="number">02</span>/<span class="number">14</span>)</div><div class="line"></div><div class="line">getNewAppName</div><div class="line">liu.cn+android<span class="meta">@gmail</span>.com</div><div class="line"><span class="number">2015</span>/<span class="number">02</span>/<span class="number">14</span></div><div class="line"><span class="number">3</span></div><div class="line"><span class="class"><span class="keyword">interface</span> <span class="title">com</span>.<span class="title">michael</span>.<span class="title">java</span>.<span class="title">annotation</span>.<span class="title">MethodInfo</span></span></div></pre></td></tr></table></figure>
<h4 id="Target为FIELD"><a href="#Target为FIELD" class="headerlink" title="@Target为FIELD"></a>@Target为FIELD</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="meta">@Target</span>(ElementType.FIELD)</div><div class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Bind &#123;</div><div class="line">	</div><div class="line">	<span class="function"><span class="keyword">int</span> <span class="title">value</span><span class="params">()</span></span>;</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FieldDemo</span> </span>&#123;</div><div class="line">	</div><div class="line">	<span class="meta">@Bind</span>(<span class="number">2</span>)</div><div class="line">	<span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> age;</div><div class="line"></div><div class="line">	<span class="comment">/**</span></div><div class="line">	 * <span class="doctag">@param</span> args</div><div class="line">	 */</div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">		<span class="comment">// TODO Auto-generated method stub</span></div><div class="line">		</div><div class="line">		Class&lt;?&gt; clz = <span class="keyword">new</span> FieldDemo().getClass();</div><div class="line">		</div><div class="line">		<span class="keyword">for</span>(Field field : clz.getFields()) &#123;</div><div class="line">			</div><div class="line">			Bind bind = field.getAnnotation(Bind.class);</div><div class="line">			</div><div class="line">			<span class="keyword">if</span> (bind != <span class="keyword">null</span>) &#123;</div><div class="line">				System.out.println(field.getName());</div><div class="line">				System.out.println(bind.value());</div><div class="line">				age = bind.value();</div><div class="line">				System.out.println(age);</div><div class="line">			&#125;</div><div class="line">		&#125;</div><div class="line"></div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">运行结果：</div><div class="line"></div><div class="line">age</div><div class="line"><span class="number">2</span></div><div class="line"><span class="number">2</span></div></pre></td></tr></table></figure>
<h3 id="编译时Annotation解析"><a href="#编译时Annotation解析" class="headerlink" title="编译时Annotation解析"></a>编译时Annotation解析</h3><p>编译时Annotation指@Retention为CLASS的Annotation，由编译器自动解析。步骤为：</p>
<ol>
<li>自定义类继承自AbstractProcessor</li>
<li>重写其中的process函数</li>
</ol>
<p>编译器在编译时自动查找所有继承自AbstractProcessor的类，然后调用它们的process方法去处理</p>
<p>假设MethodInfo的@Retention为CLASS，解析示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@SupportedAnnotationTypes</span>(&#123; <span class="string">"com.michael.java.annotation.MethodInfo"</span> &#125;)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MethodInfoProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>&#123;</div><div class="line"></div><div class="line">    <span class="meta">@Override</span></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; annotations, RoundEnvironment env)</span> </span>&#123;</div><div class="line">        HashMap&lt;String, String&gt; map = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</div><div class="line">        <span class="keyword">for</span> (TypeElement te : annotations) &#123;</div><div class="line">            <span class="keyword">for</span> (Element element : env.getElementsAnnotatedWith(te)) &#123;</div><div class="line">                MethodInfo methodInfo = element.getAnnotation(MethodInfo.class);</div><div class="line">                map.put(element.getEnclosingElement().toString(), methodInfo.author());</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>SupportedAnnotationTypes 表示这个 Processor 要处理的 Annotation 名字。<br>process 函数中参数 annotations 表示待处理的 Annotations，参数 env 表示当前或是之前的运行环境<br>process 函数返回值表示这组 annotations 是否被这个 Processor 接受，如果接受后续子的 rocessor 不会再对这个 Annotations 进行处理。</p>
<h1 id="依赖注入"><a href="#依赖注入" class="headerlink" title="依赖注入"></a>依赖注入</h1><h2 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h2><p>如果在Class A中，有Class B的实例，则称Class A对Class B有一个依赖。例如下面类Human中用到一个Father对象，我们就说Human对类Father有一个依赖。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Human</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    Father father;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Human</span><span class="params">()</span> </span>&#123;</div><div class="line">        father = <span class="keyword">new</span> Father();</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>仔细看这段代码我们会发现存在一些问题：</p>
<ol>
<li>如果现在要改变 father 生成方式，如需要用new Father(String name)初始化 father，需要修改 Human 代码；</li>
<li>如果想测试不同 Father 对象对 Human 的影响很困难，因为 father 的初始化被写死在了 Human 的构造函数中；</li>
<li>如果new Father()过程非常缓慢，单测时我们希望用已经初始化好的 father 对象 Mock 掉这个过程也很困难。</li>
</ol>
<h2 id="依赖注入-1"><a href="#依赖注入-1" class="headerlink" title="依赖注入"></a>依赖注入</h2><p>上面将依赖在构造函数中直接初始化一种Hard init形式，弊端在于两个类不够独立，不方便测试。我们还有另外一种init方式，如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Human</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    Father father;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Human</span><span class="params">(Father father)</span> </span>&#123;</div><div class="line">        <span class="keyword">this</span>.father = father;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上面代码中，我们将 father 对象作为构造函数的一个参数传入。在调用 Human 的构造方法之前外部就已经初始化好了 Father 对象。<strong>像这种非自己主动初始化依赖，而通过外部来传入依赖的方式，我们就称为依赖注入。</strong><br>现在我们发现上面 1 中存在的两个问题都很好解决了，简单的说依赖注入主要有两个好处：</p>
<ol>
<li>解耦，将依赖之间解耦。</li>
<li>因为已经解耦，所以方便做单元测试，尤其是 Mock 测试。</li>
</ol>
<h2 id="Java中的依赖注入"><a href="#Java中的依赖注入" class="headerlink" title="Java中的依赖注入"></a>Java中的依赖注入</h2><p>依赖注入的实现有很多途径，而在Java中，使用注解是最常用的。通过在字段的声明前添加@Inject注解进行标记，来实现对依赖对象的自动注入。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Human</span> </span>&#123;</div><div class="line">    ...</div><div class="line">    <span class="meta">@Inject</span> Father father;</div><div class="line">    ...</div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Human</span><span class="params">()</span> </span>&#123;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>面这段代码看起来很神奇：只是增加了一个注解，Father 对象就能自动注入了？这个注入过程是怎么完成的？<br>实质上，如果你只是写了一个 @Inject 注解，Father 并不会被自动注入。你还需要使用一个依赖注入框架，并进行简单的配置。现在 Java 语言中较流行的依赖注入框架有 Google Guice、Spring 等，而在 Android 上比较流行的有 RoboGuice、Dagger、Dagger2 等</p>

    

        <a href="/2015/12/25/Java注解Annotation和依赖注入/" class="post-more waves-effect waves-button">
            阅读全文...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </div>
    
</article>

        </li>
    
        <li class="post-list-item fade">
            <article id="post-Java反射Reflection"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time datetime="2015-12-24T12:04:06.000Z" itemprop="datePublished" class="post-time">
  2015-12-24 20:04:06
</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Java/">Java</a></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2015/12/24/Java反射Reflection/">Java反射Reflection</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent" >

    
        <h1 id="Java反射"><a href="#Java反射" class="headerlink" title="Java反射"></a>Java反射</h1><h2 id="什么是反射"><a href="#什么是反射" class="headerlink" title="什么是反射"></a>什么是反射</h2><p>Java反射是可以让我们在运行时获取类的函数、属性、父类、接口等Class内部信息的机制。通过反射还可以让我们在运行期实例化对象，调用方法，通过调用get/set方法获取和设置变量的值，即使方法或属性是类私有的也可以通过反射的形式调用，这种“看透Class“的能力被称为内省，这种能力在框架开发中尤为重要。有些情况下，我们要使用的类在运行时才会确定，这个时候我们不能在编译期就使用它，因此只能通过反射的形式来使用在运行时才存在的类（该类符合某种特定规范，例如JDBC），这是反射用得比较多的场景。</p>
<p>还有一个比较常见的场景就是编译时我们对于类的内部信息不可知，必须得到运行时才能获取类的具体信息。比如ORM框架，在运行时才能够获取类中的各个属性，然后通过反射的形式获取其属性名和值，存入数据库，这也是反射比较经典应用场景之一。</p>
<h2 id="Class类"><a href="#Class类" class="headerlink" title="Class类"></a>Class类</h2><p>既然反射是操作Class信息的，那么Class又是什么呢？</p>
<p><img src="http://7xs7a3.com1.z0.glb.clouddn.com/reflection-class%E7%B1%BB.png" alt=""></p>
<p>当我们编写完一个Java项目之后，所有的Java文件都会被编译成一个.class文件，这些Class对象承载了这个类型的父类、接口、构造函数、方法、属性等原始信息，这些class文件在程序运行时会被ClassLoader加载到虚拟机中。当一个类被加载以后，Java虚拟机就会在内存中自动产生一个Class对象。我们通过new的形式创建对象实际上就是通过这些Class来创建，只是这个过程对于我们是不透明而已。</p>
<h1 id="反射Class以及构造对象"><a href="#反射Class以及构造对象" class="headerlink" title="反射Class以及构造对象"></a>反射Class以及构造对象</h1><h2 id="获取Class对象"><a href="#获取Class对象" class="headerlink" title="获取Class对象"></a>获取Class对象</h2><p>在你想检查一个类的信息之前，你首先需要获取类的Class对象。Java中的所有类型包括基本类型，即使是数组都有与之关联的Class类的对象。如果你在编译期知道一个类的名字的话，那么你可以使用如下的方式获取一个类的Class对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">Class&lt;String&gt; myClass = String.class;</div><div class="line">System.out.println(myClass);</div><div class="line"></div><div class="line">打印：</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">String</span></span></div></pre></td></tr></table></figure>
<p>如果你已经得到了某个对象，但是你想获取这个对象的Class对象，那么你可以通过下面的方法得到：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">String str = <span class="keyword">new</span> String();</div><div class="line">Class&lt;String&gt; myClass = str.getClass();</div><div class="line">System.out.println(myClass);</div><div class="line"></div><div class="line">打印：</div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">String</span></span></div></pre></td></tr></table></figure>
<p>如果你在编译期获取不到目标类型，但是你知道它的完整类路径，那么你可以通过如下的形式来获取Class对象：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">Class&lt;?&gt; myClass = <span class="keyword">null</span>;</div><div class="line"><span class="keyword">try</span> &#123;</div><div class="line">	myClass = Class.forName(<span class="string">"java.lang.String"</span>);</div><div class="line">&#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</div><div class="line">	<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">	e.printStackTrace();</div><div class="line">&#125;</div><div class="line">System.out.println(myClass);</div><div class="line"></div><div class="line">打印结果：</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">java</span>.<span class="title">lang</span>.<span class="title">String</span></span></div></pre></td></tr></table></figure>
<p>在使用Class.forName()方法时，你必须提供一个类的全名，这个全名包括类所在的包的名字。例如String类位于java.lang包中，那么它的完整路径就是java.lang.String。如果在调用Class.forName()方法时，没有在编译路径下（classpath）找到对象的类，那么将会抛出ClassNotFoundException。</p>
<p><strong>方法说明</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line">* 加载指定的Class对象</div><div class="line">*<span class="doctag">@param</span> className 要加载的类的完整路径，例如java.lang.String。</div><div class="line">*/</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; forName(String className)<span class="keyword">throws</span> ClassNotFoundException</div><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line">* 加载指定的Class对象</div><div class="line">*<span class="doctag">@param</span> className 要加载的类的完整路径，例如java.lang.String。</div><div class="line">*<span class="doctag">@param</span> initialize 是否要初始化该Class对象</div><div class="line">*<span class="doctag">@param</span> loader  指定加载该类的ClassLoader</div><div class="line">*/</div><div class="line"><span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; forName(String name, <span class="keyword">boolean</span> initialize,ClassLoader loader)<span class="keyword">throws</span> ClassNotFoundException</div></pre></td></tr></table></figure>
<h2 id="通过Class对象构造目标类型的对象"><a href="#通过Class对象构造目标类型的对象" class="headerlink" title="通过Class对象构造目标类型的对象"></a>通过Class对象构造目标类型的对象</h2><p>一旦你拿到Class对象之后，你就可以为所欲为了，但获取Class对象只是第一步，我们需要在执行那些强大的行为之前通过Class对象构造出该类型的对象，然后才能通过该对象释放它的功能。我们知道，在java中要构造对象，必须通过该类的构造函数，那么其实反射也是一样的。但是它们确实是有区别的，通过反射构造对象，我们首先要获取类的Constructor（构造器）对象，然后通过Constructor来创建目标类的对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">classForName</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">//1.获取Class对象</span></div><div class="line">		Class&lt;?&gt; clz = Class.forName(<span class="string">"com.michael.java.reflection.Student"</span>);</div><div class="line"></div><div class="line">		<span class="comment">//2.通过Class对象获取Constructor，Student构造函数中有一个String参数</span></div><div class="line">		Constructor&lt;?&gt; constructor = clz.getConstructor(String.class);</div><div class="line"></div><div class="line">		<span class="comment">//3.通过Constructor创建Student对象</span></div><div class="line">		Student object = (Student) constructor.newInstance(<span class="string">"michael"</span>);</div><div class="line"></div><div class="line">		System.out.println(<span class="string">"obj: "</span> + object.toString());</div><div class="line">		object.showMyName();</div><div class="line">		object.takeAnExamination();</div><div class="line"></div><div class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">		<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">打印结果：</div><div class="line"></div><div class="line">obj:  Student :  michael</div><div class="line">My name is michael</div><div class="line"> takeAnExamination</div></pre></td></tr></table></figure>
<p>通过上述代码，我们就可以在运行时通过完整的类名来构建对象。</p>
<p><strong>获取构造函数方法</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//获取一个公有的构造函数，参数为可变参数，如果构造函数有参数，那么需要将参数的类型传递给getConstructor方法</span></div><div class="line"><span class="function"><span class="keyword">public</span> Constructor&lt;T&gt; <span class="title">getConstructor</span><span class="params">(Class&lt;?&gt;... parameterTypes)</span></span></div><div class="line"></div><div class="line"><span class="comment">//获取目标类所有的公有构造函数</span></div><div class="line"><span class="keyword">public</span> Constructor&lt;?&gt;[] <span class="title">getConstructors</span><span class="params">()</span> <span class="keyword">throws</span> SecurityException</div></pre></td></tr></table></figure>
<blockquote>
<p>注意，当你通过反射获取到Constructor、Method、Filed后，在反射调用之前将此对象的accessible标志设置为true，以此来提升反射速度。值为true则指示反射的对象在使用时应该取消Java语言访问检查。值为false则指示反射的对象应该实施Java语言访问检查。例如：</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">//设置Constructor的Accessible</span></div><div class="line">Constructor&lt;?&gt; constructor = clz.getConstructor(String.class);</div><div class="line">constructor.setAccessible(<span class="keyword">true</span>);</div><div class="line"></div><div class="line">Method learnMethod = Student.class.getMethod(<span class="string">"learn"</span>, String.class);</div><div class="line"><span class="comment">//设置Method的Accessible</span></div><div class="line">learnMethod.setAccessible(<span class="keyword">true</span>);</div></pre></td></tr></table></figure>
<p>Student.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.michael.java.reflection;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">extends</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Examination</span></span>&#123;</div><div class="line"></div><div class="line">    <span class="comment">// 年级</span></div><div class="line">    <span class="keyword">public</span> <span class="keyword">int</span> mGrade;</div><div class="line">    <span class="keyword">private</span> String age;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(String aName)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(aName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Student</span><span class="params">(<span class="keyword">int</span> grade, String aName)</span> </span>&#123;</div><div class="line">        <span class="keyword">super</span>(aName);</div><div class="line">        mGrade = grade;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">learn</span><span class="params">(String course,<span class="keyword">int</span> count)</span> </span>&#123;</div><div class="line">        System.out.println(mName + <span class="string">" learn "</span> + course + <span class="string">"--"</span>+ count);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">takeAnExamination</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">" takeAnExamination "</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</div><div class="line">        <span class="keyword">return</span> <span class="string">" Student :  "</span> + mName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Person.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.michael.java.reflection;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</div><div class="line"></div><div class="line">    String mName;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Person</span><span class="params">(String aName)</span> </span>&#123;</div><div class="line">        mName = aName;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sayHello</span><span class="params">(String friendName)</span> </span>&#123;</div><div class="line">        System.out.println(mName + <span class="string">" say hello to "</span> + friendName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">showMyName</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">"My name is "</span> + mName);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">breathe</span><span class="params">()</span> </span>&#123;</div><div class="line">        System.out.println(<span class="string">" take breathe "</span>);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Examination.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.michael.java.reflection;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Examination</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">takeAnExamination</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>Breathe.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">package</span> com.michael.java.reflection;</div><div class="line"></div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Breathe</span> </span>&#123;</div><div class="line"></div><div class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">breathe</span><span class="params">()</span></span>;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="反射获取类中函数"><a href="#反射获取类中函数" class="headerlink" title="反射获取类中函数"></a>反射获取类中函数</h1><h2 id="获取当前类中定义的方法"><a href="#获取当前类中定义的方法" class="headerlink" title="获取当前类中定义的方法"></a>获取当前类中定义的方法</h2><p>要获取当前类中定义的所有方法可以通过Class中的getDeclaredMethods函数，它会获取当前类中的public、default、protected、private的所有方法。<code>getDeclaredMethod(String name, Class...&lt;?&gt; parameterTypes)</code>则是获取某个指定的方法。代码示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">showDeclaredMethods</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">	Student student = <span class="keyword">new</span> Student(<span class="string">"Michael"</span>);</div><div class="line"></div><div class="line">	<span class="comment">// 获取类中所有方法</span></div><div class="line">	Method[] methods = student.getClass().getDeclaredMethods();</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (Method method : methods) &#123;</div><div class="line"></div><div class="line">		System.out.println(<span class="string">"方法名: "</span> + method.getName());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		Method learnMethod = student.getClass().getDeclaredMethod(<span class="string">"learn"</span>,</div><div class="line">				String.class, Integer.TYPE);</div><div class="line">		<span class="comment">// 获取方法的参数类型列表</span></div><div class="line">		Class&lt;?&gt;[] paramClasses = learnMethod.getParameterTypes();</div><div class="line"></div><div class="line">		<span class="keyword">for</span> (Class&lt;?&gt; clz : paramClasses) &#123;</div><div class="line">			System.out.println(<span class="string">"learn 方法的参数类型: "</span> + clz.getName());</div><div class="line">		&#125;</div><div class="line"></div><div class="line">		<span class="comment">// 是否是 private 函数，属性是否是 private 也可以使用这种方式判断</span></div><div class="line">		System.out.println(learnMethod.getName() + <span class="string">" is private method: "</span></div><div class="line">				+ Modifier.isPrivate(learnMethod.getModifiers()));</div><div class="line"></div><div class="line">		<span class="comment">//调用私有learn函数</span></div><div class="line">		learnMethod.setAccessible(<span class="keyword">true</span>);</div><div class="line">		learnMethod.invoke(student, <span class="string">"java---&gt;"</span>,<span class="number">2</span>);</div><div class="line"></div><div class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">		<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;</div><div class="line"></div><div class="line">&#125;</div><div class="line"></div><div class="line">运行结果:</div><div class="line"></div><div class="line">方法名: toString</div><div class="line">方法名: learn</div><div class="line">方法名: takeAnExamination</div><div class="line">learn 方法的参数类型: java.lang.String</div><div class="line">learn 方法的参数类型: <span class="keyword">int</span></div><div class="line">learn is <span class="keyword">private</span> method: <span class="keyword">true</span></div><div class="line">Michael learn java---&gt;---<span class="number">2</span></div></pre></td></tr></table></figure>
<h2 id="获取当前类、父类中定义的公有方法"><a href="#获取当前类、父类中定义的公有方法" class="headerlink" title="获取当前类、父类中定义的公有方法"></a>获取当前类、父类中定义的公有方法</h2><p>要获取当前类以及父类中的所有public方法可以通过Class中的getMethods函数，而getMethod则是获取某个指定的方法。代码示例如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">showMethods</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">	Student student = <span class="keyword">new</span> Student(<span class="string">"Michael"</span>);</div><div class="line">	<span class="comment">//获取所有公有方法</span></div><div class="line">	Method[] methods = student.getClass().getMethods();</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(Method method : methods)&#123;</div><div class="line">		System.out.println(<span class="string">"公有方法名： "</span> + method.getName());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">//通过 getMethod 只能获取公有方法，如果获取私有方法则会抛出异常</span></div><div class="line">		Method method = student.getClass().getMethod(<span class="string">"takeAnExamination"</span>);</div><div class="line"></div><div class="line">		method.invoke(student);</div><div class="line"></div><div class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">		<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">结果打印：</div><div class="line"></div><div class="line">公有方法名： toString</div><div class="line">公有方法名： takeAnExamination</div><div class="line">公有方法名： breathe</div><div class="line">公有方法名： wait</div><div class="line">公有方法名： wait</div><div class="line">公有方法名： wait</div><div class="line">公有方法名： equals</div><div class="line">公有方法名： hashCode</div><div class="line">公有方法名： getClass</div><div class="line">公有方法名： notify</div><div class="line">公有方法名： notifyAll</div><div class="line"> takeAnExamination</div></pre></td></tr></table></figure>
<p><strong>接口说明</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//获取Class对象中指定的所有函数，不包括从父类继承的函数</span></div><div class="line"><span class="keyword">public</span> Method[] getDeclaredMethods()</div><div class="line"></div><div class="line"><span class="comment">//获取Class对象中指定函数名和参数的函数，参数name表示函数名；参数parameterTypes表示参数类型列表</span></div><div class="line"><span class="function"><span class="keyword">public</span> Method <span class="title">getDeclaredMethod</span><span class="params">(String name, Class&lt;?&gt;... parameterTypes)</span></span></div><div class="line"></div><div class="line"><span class="comment">//获取Class对象中的所有公有函数（包括从父类和接口类继承的函数）</span></div><div class="line"><span class="keyword">public</span> Method[] <span class="title">getMethods</span><span class="params">()</span></div><div class="line"></div><div class="line"><span class="comment">//获取Class对象中指定函数名和参数的公有函数，参数name表示函数名；参数parameterTypes表示参数类型列表</span></div><div class="line"><span class="keyword">public</span> Method <span class="title">getMethod</span><span class="params">(String name, Class&lt;?&gt;... parameterTypes)</span></div></pre></td></tr></table></figure>
<p>这里需要注意的是 getDeclaredMethod 和 getDeclaredMethods 包含 private、protected、default、public 的函数，并且通过这两个函数获取到的只是在自身中定义的函数，从父类中集成的函数不能够获取到。而 getMethod 和 getMethods 只包含 public 函数，父类中的公有函数也能够获取到。</p>
<h1 id="反射类获取类中的属性"><a href="#反射类获取类中的属性" class="headerlink" title="反射类获取类中的属性"></a>反射类获取类中的属性</h1><h2 id="获取当前类中定义的属性"><a href="#获取当前类中定义的属性" class="headerlink" title="获取当前类中定义的属性"></a>获取当前类中定义的属性</h2><p>要获取当前类中定义的所有属性可以通过Class中的getDeclaredFields函数，它会获取到当前类中的public、protected、private的所有属性，而getDeclaredField则是获取指定的属性。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">showDeclaredFields</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">	Student student = <span class="keyword">new</span> Student(<span class="string">"Michael"</span>);</div><div class="line"></div><div class="line">	<span class="comment">//获取当前类的所有属性</span></div><div class="line">	Field[] fields = student.getClass().getDeclaredFields();</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(Field field : fields) &#123;</div><div class="line">		System.out.println(<span class="string">"属性名： "</span> + field.getName());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		<span class="comment">//获取当前类的指定属性</span></div><div class="line">		Field gradeField = student.getClass().getDeclaredField(<span class="string">"mGrade"</span>);</div><div class="line">		<span class="comment">//获取属性值</span></div><div class="line">		System.out.println(<span class="string">"grade is:"</span> + gradeField.getInt(student));</div><div class="line">		<span class="comment">//设置属性值</span></div><div class="line">		gradeField.set(student, <span class="number">10</span>);</div><div class="line">		System.out.println(<span class="string">"grade is:"</span> + gradeField.getInt(student));</div><div class="line"></div><div class="line">		Field ageField = student.getClass().getDeclaredField(<span class="string">"age"</span>);</div><div class="line">		ageField.setAccessible(<span class="keyword">true</span>);</div><div class="line">		System.out.println(<span class="string">"age: "</span> + ageField.get(student));</div><div class="line"></div><div class="line">		ageField.set(student, <span class="string">"26"</span>);</div><div class="line"></div><div class="line">		System.out.println(<span class="string">"age: "</span> + ageField.get(student));</div><div class="line"></div><div class="line"></div><div class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">		<span class="comment">// TODO Auto-generated catch block</span></div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">结果打印：</div><div class="line"></div><div class="line">属性名： mGrade</div><div class="line">属性名： age</div><div class="line">grade is:<span class="number">0</span></div><div class="line">grade is:<span class="number">10</span></div><div class="line">age: <span class="keyword">null</span></div><div class="line">age: <span class="number">26</span></div></pre></td></tr></table></figure>
<h2 id="获取当前类、父类中定义的公有属性"><a href="#获取当前类、父类中定义的公有属性" class="headerlink" title="获取当前类、父类中定义的公有属性"></a>获取当前类、父类中定义的公有属性</h2><p>要获取当前类以及父类中的所有 public 属性可以通过 Class 中的 getFields 函数，而 getField 则是获取某个指定的属性。代码示例如下 :</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">private static void showFields() &#123;</div><div class="line"></div><div class="line">	Student student = new Student("Michael");</div><div class="line"></div><div class="line">	//获取当前类的所有属性</div><div class="line">	Field[] fields = student.getClass().getFields();</div><div class="line"></div><div class="line">	for(Field field : fields) &#123;</div><div class="line">		System.out.println("属性名： " + field.getName());</div><div class="line">	&#125;</div><div class="line"></div><div class="line">	try &#123;</div><div class="line">		//获取当前类的指定属性</div><div class="line">		Field gradeField = student.getClass().getField("mGrade");</div><div class="line">		//获取属性值</div><div class="line">		System.out.println("grade is:" + gradeField.getInt(student));</div><div class="line">		//设置属性值</div><div class="line">		gradeField.set(student, 10);</div><div class="line">		System.out.println("grade is:" + gradeField.getInt(student));</div><div class="line"></div><div class="line">		//getField()方法不能获取私有属性</div><div class="line">		Field ageField = student.getClass().getField("age");</div><div class="line">		//私有属性需调用次函数 JDK 1.8</div><div class="line">		ageField.setAccessible(true);</div><div class="line">		System.out.println("age: " + ageField.get(student));</div><div class="line"></div><div class="line"></div><div class="line">	&#125; catch (Exception e) &#123;</div><div class="line">		// TODO Auto-generated catch block</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">结果打印：</div><div class="line"></div><div class="line">属性名： mGrade</div><div class="line">grade is:0</div><div class="line">grade is:10</div><div class="line">java.lang.NoSuchFieldException: age  ##getField()方法不能获取私有属性</div><div class="line">	at java.lang.Class.getField(Unknown Source)</div><div class="line">	at com.michael.java.reflection.Main.showFields(Main.java:153)</div><div class="line">	at com.michael.java.reflection.Main.main(Main.java:172)</div></pre></td></tr></table></figure>
<p><strong>接口说明</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 获取 Class 对象中指定属性名的属性，参数一为属性名</span></div><div class="line"><span class="function"><span class="keyword">public</span> Method <span class="title">getDeclaredField</span> <span class="params">(String name)</span></span></div><div class="line"></div><div class="line"><span class="comment">// 获取该 Class 对象中的所有属性( 不包含从父类继承的属性 )</span></div><div class="line"><span class="keyword">public</span> Method[] <span class="title">getDeclaredFields</span> <span class="params">()</span></div><div class="line"></div><div class="line"><span class="comment">// 获取Class 对象中的指定的公有属性，参数一为属性名</span></div><div class="line"><span class="keyword">public</span> Method <span class="title">getField</span> <span class="params">(String name)</span></div><div class="line"></div><div class="line"><span class="comment">// 获取该 Class 对象中的所有公有属性 ( 包含从父类和接口类集成下来的公有属性 )</span></div><div class="line"><span class="keyword">public</span> Method[] <span class="title">getFields</span> <span class="params">()</span></div></pre></td></tr></table></figure>
<p>这里需要注意的是 getDeclaredField 和 getDeclaredFields 包含 private、protected、default、public 的属性，并且通过这两个函数获取到的只是在自身中定义的属性，从父类中集成的属性不能够获取到。而 getField 和 getFields 只包含 public 属性，父类中的公有属性也能够获取到。</p>
<h1 id="反射获取父类与接口"><a href="#反射获取父类与接口" class="headerlink" title="反射获取父类与接口"></a>反射获取父类与接口</h1><h2 id="获取父类"><a href="#获取父类" class="headerlink" title="获取父类"></a>获取父类</h2><p>获取Class对象的父类</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">private static void showSuperClass() &#123;</div><div class="line"></div><div class="line">	Student student = new Student("Michael");</div><div class="line">	Class&lt;?&gt; superClass = student.getClass().getSuperclass();</div><div class="line"></div><div class="line">	while(superClass != null) &#123;</div><div class="line">		System.out.println("super class is : " + superClass.getName());</div><div class="line"></div><div class="line">		//再获取父类的上一层父类，知道最后的Object类，Object的父类为null</div><div class="line">		superClass = superClass.getSuperclass();</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">打印结果:</div><div class="line"></div><div class="line">super class is : com.michael.java.reflection.Person</div><div class="line">super class is : java.lang.Object</div></pre></td></tr></table></figure>
<h2 id="获取接口"><a href="#获取接口" class="headerlink" title="获取接口"></a>获取接口</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">showIntefaces</span><span class="params">()</span> </span>&#123;</div><div class="line">	Student student = <span class="keyword">new</span> Student(<span class="string">"Michael"</span>);</div><div class="line">	Class&lt;?&gt;[] interfaces = student.getClass().getInterfaces();</div><div class="line"></div><div class="line">	<span class="keyword">for</span>(Class&lt;?&gt; clz : interfaces) &#123;</div><div class="line">		System.out.println(<span class="string">"Student的接口有: "</span> + clz.getName());</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">结果打印：</div><div class="line"></div><div class="line">Student的接口有: com.michael.java.reflection.Examination</div></pre></td></tr></table></figure>
<h1 id="获取注解信息"><a href="#获取注解信息" class="headerlink" title="获取注解信息"></a>获取注解信息</h1><p>在框架开发中，注解加反射的组合使用是最为常见形式的。定义注解时我们会通过@Target 指定该注解能够作用的类型，看如下示例:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Target</span>(&#123;</div><div class="line">		ElementType.METHOD, ElementType.FIELD, ElementType.TYPE</div><div class="line">&#125;)</div><div class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</div><div class="line"><span class="keyword">static</span> <span class="meta">@interface</span> Test &#123;</div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>上述注解的@target 表示该注解只能用在函数上，还有 Type、Field、PARAMETER 等类型，可以参考上述给出的参考资料。通过反射 api 我们也能够获取一个 Class 对象获取类型、属性、函数等相关的对象，通过这些对象的 getAnnotation 接口获取到对应的注解信息。 首先我们需要在目标对象上添加上注解，例如 :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="meta">@Test</span>(tag = <span class="string">"Student class Test Annoatation"</span>)</div><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Student</span> <span class="keyword">extends</span> <span class="title">Person</span> <span class="keyword">implements</span> <span class="title">Examination</span> </span>&#123;</div><div class="line">    <span class="comment">// 年级</span></div><div class="line">    <span class="meta">@Test</span>(tag = <span class="string">"mGrade Test Annotation "</span>)</div><div class="line">    <span class="keyword">int</span> mGrade;</div><div class="line"></div><div class="line">    <span class="comment">// ......</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>然后通过相关的注解函数得到注解信息，如下所示 :</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getAnnotationInfos</span><span class="params">()</span> </span>&#123;</div><div class="line">	Student student = <span class="keyword">new</span> Student(<span class="string">"mr.simple"</span>);</div><div class="line">	Test classTest = student.getClass().getAnnotation(Test.class);</div><div class="line">	System.out.println(<span class="string">"class Annotatation tag = "</span> + classTest.tag());</div><div class="line"></div><div class="line">	Field field = <span class="keyword">null</span>;</div><div class="line">	<span class="keyword">try</span> &#123;</div><div class="line">		field = student.getClass().getDeclaredField(<span class="string">"mGrade"</span>);</div><div class="line">		Test testAnnotation = field.getAnnotation(Test.class);</div><div class="line">		System.out.println(<span class="string">"属性的 Test 注解 tag : "</span> + testAnnotation.tag());</div><div class="line">	&#125; <span class="keyword">catch</span> (Exception e) &#123;</div><div class="line">		e.printStackTrace();</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>输出结果为：<br><figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">class Annotatation tag = Student class Test Annoatation</div><div class="line">属性的 Test 注解 tag : mGrade Test Annotation</div></pre></td></tr></table></figure></p>
<p><strong>接口说明</strong><br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="comment">// 获取指定类型的注解</span></div><div class="line"><span class="keyword">public</span> &lt;A extends Annotation&gt; <span class="function">A <span class="title">getAnnotation</span><span class="params">(Class&lt;A&gt; annotationClass)</span> </span>;</div><div class="line"><span class="comment">// 获取 Class 对象中的所有注解</span></div><div class="line"><span class="keyword">public</span> Annotation[] getAnnotations() ;</div></pre></td></tr></table></figure></p>
<h1 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h1><p>反射作为 Java 语言的重要特性，在开发中有着极为重要的作用。很多开发框架都是基于反射来实现对目标对象的操作，而反射配合注解更是设计开发框架的主流选择</p>

    

        <a href="/2015/12/24/Java反射Reflection/" class="post-more waves-effect waves-button">
            阅读全文...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </div>
    
</article>

        </li>
    
        <li class="post-list-item fade">
            <article id="post-Java集合之并发容器LinkedBlockingQueue"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time datetime="2015-12-23T14:40:21.000Z" itemprop="datePublished" class="post-time">
  2015-12-23 22:40:21
</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Java/">Java</a></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2015/12/23/Java集合之并发容器LinkedBlockingQueue/">Java集合之并发容器LinkedBlockingQueue</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent" >

    
        <p>LinkedBlockingQueue是一个基于已链接节点的、范围任意的阻塞队列的实现。 此队列按 FIFO（先进先出）排序元素。队列的头部 是在队列中时间最长的元素。队列的尾部 是在队列中时间最短的元素。新元素插入到队列的尾部，并且队列检索操作会获得位于队列头部的元素。链接队列的吞吐量通常要高于基于数组的队列， 但是在大多数并发应用程序中，其可预知的性能要低。</p>
<p>可选的容量范围构造方法参数作为防止队列过度扩展的一种方法。如果未指定容量，则它等于 Integer.MAX_VALUE。除非插入节点会使队列超出容量，否则每次插入后会动态地创建链接节点。</p>
<h1 id="签名"><a href="#签名" class="headerlink" title="签名"></a>签名</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkedBlockingQueue</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractQueue</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">        <span class="keyword">implements</span> <span class="title">BlockingQueue</span>&lt;<span class="title">E</span>&gt;, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></div></pre></td></tr></table></figure>
<p>LinkedBlockingQueue实现是线程安全的，实现了先进先出等特性，是作为生产者消费者的首选</p>
<h1 id="构造函数"><a href="#构造函数" class="headerlink" title="构造函数"></a>构造函数</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedBlockingQueue</span><span class="params">()</span> </span>&#123;</div><div class="line">	<span class="keyword">this</span>(Integer.MAX_VALUE);</div><div class="line">&#125;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">LinkedBlockingQueue</span><span class="params">(<span class="keyword">int</span> capacity)</span> </span>&#123;</div><div class="line">	<span class="keyword">if</span> (capacity &lt;= <span class="number">0</span>) <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException();</div><div class="line">	<span class="keyword">this</span>.capacity = capacity;</div><div class="line">	last = head = <span class="keyword">new</span> Node&lt;E&gt;(<span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">LinkedBlockingQueueDemo</span> </span>&#123;</div><div class="line"></div><div class="line">	 <span class="comment">/**</span></div><div class="line">     * </div><div class="line">     * 定义装苹果的篮子</div><div class="line">     * </div><div class="line">     */</div><div class="line">    <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Basket</span> </span>&#123;</div><div class="line">        <span class="comment">// 篮子，能够容纳3个苹果</span></div><div class="line">        BlockingQueue&lt;String&gt; basket = <span class="keyword">new</span> LinkedBlockingQueue&lt;String&gt;(<span class="number">3</span>);</div><div class="line"></div><div class="line">        <span class="comment">// 生产苹果，放入篮子</span></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">produce</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">            <span class="comment">// put方法放入一个苹果，若basket满了，等到basket有位置</span></div><div class="line">            basket.put(<span class="string">"An apple"</span>); <span class="comment">//阻塞</span></div><div class="line"> <span class="comment">//           basket.offer("An Apple"); //非阻塞</span></div><div class="line">         &#125;</div><div class="line"></div><div class="line">        <span class="comment">// 消费苹果，从篮子中取走</span></div><div class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">consume</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</div><div class="line">            <span class="comment">// take方法取出一个苹果，若basket为空，等到basket有苹果为止(获取并移除此队列的头部)</span></div><div class="line">            <span class="keyword">return</span> basket.take();  <span class="comment">//阻塞</span></div><div class="line">            <span class="comment">//return basket.poll(); //非阻塞</span></div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 定义苹果生产者</span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Producer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> String instance;</div><div class="line">        <span class="keyword">private</span> Basket basket;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Producer</span><span class="params">(String instance, Basket basket)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.instance = instance;</div><div class="line">            <span class="keyword">this</span>.basket = basket;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                    <span class="comment">// 生产苹果</span></div><div class="line">                    System.out.println(<span class="string">"生产者准备生产苹果："</span> + instance);</div><div class="line">                    basket.produce();</div><div class="line">                    <span class="comment">// 休眠300ms</span></div><div class="line">                    Thread.sleep(<span class="number">300</span>);</div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</div><div class="line">                System.out.println(<span class="string">"Producer Interrupted"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="comment">// 定义苹果消费者</span></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Consumer</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line">        <span class="keyword">private</span> String instance;</div><div class="line">        <span class="keyword">private</span> Basket basket;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="title">Consumer</span><span class="params">(String instance, Basket basket)</span> </span>&#123;</div><div class="line">            <span class="keyword">this</span>.instance = instance;</div><div class="line">            <span class="keyword">this</span>.basket = basket;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">            <span class="keyword">try</span> &#123;</div><div class="line">                <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</div><div class="line">                    <span class="comment">// 消费苹果</span></div><div class="line">                    System.out.println(<span class="string">"消费者准备消费苹果："</span> + instance);</div><div class="line">                    System.out.println(<span class="string">"consume: "</span> + basket.consume());</div><div class="line">                    <span class="comment">// 休眠1000ms</span></div><div class="line"><span class="comment">//                    Thread.sleep(1000);</span></div><div class="line">                &#125;</div><div class="line">            &#125; <span class="keyword">catch</span> (InterruptedException ex) &#123;</div><div class="line">                System.out.println(<span class="string">"Consumer Interrupted"</span>);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</div><div class="line">    	</div><div class="line">        LinkedBlockingQueueDemo test = <span class="keyword">new</span> LinkedBlockingQueueDemo();</div><div class="line"></div><div class="line">        <span class="comment">// 建立一个装苹果的篮子</span></div><div class="line">        Basket basket = test.new Basket();</div><div class="line"></div><div class="line">        ExecutorService service = Executors.newCachedThreadPool();</div><div class="line">        Producer producer = test.new Producer(<span class="string">"生产者001"</span>, basket);</div><div class="line"><span class="comment">//        Producer producer2 = test.new Producer("生产者002", basket);</span></div><div class="line"><span class="comment">//        Consumer consumer = test.new Consumer("消费者001", basket);</span></div><div class="line">        service.submit(producer);</div><div class="line"><span class="comment">//        service.submit(producer2);</span></div><div class="line"><span class="comment">//        service.submit(consumer);</span></div><div class="line">        <span class="comment">// 程序运行5s后，所有任务停止</span></div><div class="line"><span class="comment">//        try &#123;</span></div><div class="line"><span class="comment">//            Thread.sleep(1000 * 1);</span></div><div class="line"><span class="comment">//        &#125; catch (InterruptedException e) &#123;</span></div><div class="line"><span class="comment">//            e.printStackTrace();</span></div><div class="line"><span class="comment">//        &#125;</span></div><div class="line"><span class="comment">//        service.shutdownNow();</span></div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">&#125;</div></pre></td></tr></table></figure>
    

        <a href="/2015/12/23/Java集合之并发容器LinkedBlockingQueue/" class="post-more waves-effect waves-button">
            阅读全文...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Collection/">Collection</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/并发编程/">并发编程</a></li></ul>

    </div>
    
</article>

        </li>
    
        <li class="post-list-item fade">
            <article id="post-Java集合之并发容器ConcurrentLinkedQueue"
  class="article-card article-type-post" itemprop="blogPost">

    <div class="post-meta">
        <time datetime="2015-12-23T14:35:21.000Z" itemprop="datePublished" class="post-time">
  2015-12-23 22:35:21
</time>

        
	<ul class="article-category-list"><li class="article-category-list-item"><a class="article-category-list-link" href="/categories/Java/">Java</a></li></ul>



    </div>

    


  
    <h3 class="post-title" itemprop="name">
      <a class="post-title-link" href="/2015/12/23/Java集合之并发容器ConcurrentLinkedQueue/">Java集合之并发容器ConcurrentLinkedQueue</a>
    </h3>
  




    <div class="post-content" id="post-content" itemprop="postContent" >

    
        <p>在并发编程中我们有时候需要使用线程安全的队列。如果我们要实现一个线程安全的队列，有两种实现方式，一种是阻塞式队列，另外一种是非阻塞式队列。使用阻塞算法的队列可以用一个锁（入队和出对用同一把锁）或两个锁（入队和出对用不同的锁）等方式来实现，而非阻塞的实现则可以使用CAS的方式来实现。ConcurrentLinkedQueue是基于非阻塞式来实现的线程安全队列。</p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>ConcurrentLinkedQueue是一个基于链接节点的无界线程安全队列，它采用先进先出的规则对节点进行排序，当我们添加一个元素的时候，它会添加到队列的尾部，当我们获取一个元素的时候，它会返回队列头部的元素。它采用了“wait-free”算法来实现。</p>
<h1 id="签名"><a href="#签名" class="headerlink" title="签名"></a>签名</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcurrentLinkedQueue</span>&lt;<span class="title">E</span>&gt; <span class="keyword">extends</span> <span class="title">AbstractQueue</span>&lt;<span class="title">E</span>&gt;</span></div><div class="line">        <span class="keyword">implements</span> <span class="title">Queue</span>&lt;<span class="title">E</span>&gt;, <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span></div></pre></td></tr></table></figure>
<h1 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h1><p>首先来看看ConcurrentLinkedQueue的类图</p>
<p><img src="http://7xs7a3.com1.z0.glb.clouddn.com/ConcurrentLinkedQueue-%E7%B1%BB%E5%9B%BE.jpg" alt=""></p>
<p>ConcurrentLinkedQueue由head节点和tail节点组成，每个节点（Node）由节点元素（item）和指向下一个节点的引用（next）组成，从而组成一张链表结构的队列。默认情况下head节点存储的元素为空，tail节点等于header节点</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;E&gt; head;</div><div class="line"></div><div class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">volatile</span> Node&lt;E&gt; tail;</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">ConcurrentLinkedQueue</span><span class="params">()</span> </span>&#123;</div><div class="line">	head = tail = <span class="keyword">new</span> Node&lt;E&gt;(<span class="keyword">null</span>);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="offer入队列"><a href="#offer入队列" class="headerlink" title="offer入队列"></a>offer入队列</h1><p>入队列就是将新元素添加到队列的尾部，如下图所示</p>
<p><img src="http://7xs7a3.com1.z0.glb.clouddn.com/ConcurrentLinekedQueue-%E9%98%9F%E5%88%97%E5%85%A5%E9%98%9F%E7%BB%93%E6%9E%84%E5%8F%98%E5%8C%96%E5%9B%BE.jpg" alt=""></p>
<ul>
<li>第一步添加元素1。队列更新head节点的next节点为元素1节点。又因为tail节点默认情况下等于head节点，所以它们的next节点都指向元素1节点。</li>
<li>第二步添加元素2。队列首先设置元素1节点的next节点为元素2节点，然后更新tail节点指向元素2节点。</li>
<li>第三步添加元素3，设置tail节点的next节点为元素3节点。</li>
<li>第四步添加元素4，设置元素3的next节点为元素4节点，然后将tail节点指向元素4节点。</li>
</ul>
<p>入队过程主要做两件事情：第一是将入队节点设置成当前队列尾节点的下一个节点。第二是更新tail节点，如果tail节点的next节点不为空，则将入队节点设置成tail节点；如果tail节点的next节点为空，则将入队节点设置成tail的next节点，所以tail节点不总是尾节点。</p>
<p>上面的分析让我们从单线程入队的角度来理解入队过程，但是多个线程同时进行入队情况就变得更加复杂，因为可能会出现其他线程插队的情况。如果有一个线程正在入队，那么它必须先获取尾节点，然后设置尾节点的下一个节点为入队节点，但这时可能有另外一个线程插队了，那么队列的尾节点就会发生变化，这时当前线程要暂停入队操作，然后重新获取尾节点。让我们再通过源码来详细分析下它是如何使用CAS算法来入队的。</p>
<p>源码分析：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</div><div class="line">	checkNotNull(e);</div><div class="line">	<span class="comment">//创建一个新节点</span></div><div class="line">	<span class="keyword">final</span> Node&lt;E&gt; newNode = <span class="keyword">new</span> Node&lt;E&gt;(e);</div><div class="line"></div><div class="line">	<span class="keyword">for</span> (Node&lt;E&gt; t = tail, p = t;;) &#123;</div><div class="line">		Node&lt;E&gt; q = p.next;</div><div class="line">		<span class="keyword">if</span> (q == <span class="keyword">null</span>) &#123;</div><div class="line">			<span class="comment">// p is last node</span></div><div class="line">			<span class="keyword">if</span> (p.casNext(<span class="keyword">null</span>, newNode)) &#123;</div><div class="line">				<span class="comment">// Successful CAS is the linearization point</span></div><div class="line">				<span class="comment">// for e to become an element of this queue,</span></div><div class="line">				<span class="comment">// and for newNode to become "live".</span></div><div class="line">				<span class="keyword">if</span> (p != t) <span class="comment">// hop two nodes at a time</span></div><div class="line">					casTail(t, newNode);  <span class="comment">// Failure is OK.</span></div><div class="line">				<span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="comment">// Lost CAS race to another thread; re-read next</span></div><div class="line">		&#125;</div><div class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (p == q)</div><div class="line">			<span class="comment">// We have fallen off list.  If tail is unchanged, it</span></div><div class="line">			<span class="comment">// will also be off-list, in which case we need to</span></div><div class="line">			<span class="comment">// jump to head, from which all live nodes are always</span></div><div class="line">			<span class="comment">// reachable.  Else the new tail is a better bet.</span></div><div class="line">			p = (t != (t = tail)) ? t : head;</div><div class="line">		<span class="keyword">else</span></div><div class="line">			<span class="comment">// Check for tail updates after two hops.</span></div><div class="line">			p = (p != t &amp;&amp; t != (t = tail)) ? t : q;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h1 id="poll出队列"><a href="#poll出队列" class="headerlink" title="poll出队列"></a>poll出队列</h1><p>出队列的就是从队列里返回一个节点元素，并清空该节点对元素的引用。</p>
<p><img src="http://7xs7a3.com1.z0.glb.clouddn.com/ConcurrentLinekedQueue-%E9%98%9F%E5%88%97%E5%87%BA%E9%98%9F%E7%BB%93%E6%9E%84%E5%8F%98%E5%8C%96%E5%9B%BE.jpg" alt=""></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> E <span class="title">poll</span><span class="params">()</span> </span>&#123;</div><div class="line">	restartFromHead:</div><div class="line">	<span class="keyword">for</span> (;;) &#123;</div><div class="line">		<span class="keyword">for</span> (Node&lt;E&gt; h = head, p = h, q;;) &#123;</div><div class="line">			E item = p.item;</div><div class="line"></div><div class="line">			<span class="keyword">if</span> (item != <span class="keyword">null</span> &amp;&amp; p.casItem(item, <span class="keyword">null</span>)) &#123;</div><div class="line">				<span class="comment">// Successful CAS is the linearization point</span></div><div class="line">				<span class="comment">// for item to be removed from this queue.</span></div><div class="line">				<span class="keyword">if</span> (p != h) <span class="comment">// hop two nodes at a time</span></div><div class="line">					updateHead(h, ((q = p.next) != <span class="keyword">null</span>) ? q : p);</div><div class="line">				<span class="keyword">return</span> item;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> <span class="keyword">if</span> ((q = p.next) == <span class="keyword">null</span>) &#123;</div><div class="line">				updateHead(h, p);</div><div class="line">				<span class="keyword">return</span> <span class="keyword">null</span>;</div><div class="line">			&#125;</div><div class="line">			<span class="keyword">else</span> <span class="keyword">if</span> (p == q)</div><div class="line">				<span class="keyword">continue</span> restartFromHead;</div><div class="line">			<span class="keyword">else</span></div><div class="line">				p = q;</div><div class="line">		&#125;</div><div class="line">	&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
    

        <a href="/2015/12/23/Java集合之并发容器ConcurrentLinkedQueue/" class="post-more waves-effect waves-button">
            阅读全文...
        </a>
    </div>
    
    <div class="post-footer">
        
	<ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Collection/">Collection</a></li><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/并发编程/">并发编程</a></li></ul>

    </div>
    
</article>

        </li>
    
    </ul>

    
<nav id="page-nav">
    <div class="inner">
    <a class="extend prev" rel="prev" href="/page/8/">上一页</a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/10/">下一页</a>
    </div>
</nav>


</div>

  </main>
  <div class="mask" id="mask"></div>
<a href="javascript:;" id="gotop" class="waves-effect waves-circle waves-light"><span class="icon icon-lg icon-chevron-up"></span></a>
<script>
var BLOG = { ROOT: '/', SHARE: true, REWARD: false }</script>



<div class="global-share" id="globalShare">
    <div class="tit">分享到：</div>
    <ul class="reset share-icons">
      <li>
        <a class="weibo share-sns" target="_blank" href="http://service.weibo.com/share/share.php?url=http://yoursite.com/page/9/&title=刘涤生 - 应尽便须尽&pic=http://yoursite.com/icon.jpg" data-title="微博">
          <i class="icon icon-weibo"></i>
        </a>
      </li>
      <li>
        <a class="weixin share-sns wxFab" href="javascript:;" data-title="微信">
          <i class="icon icon-weixin"></i>
        </a>
      </li>
      <li>
        <a class="qq share-sns" target="_blank" href="http://connect.qq.com/widget/shareqq/index.html?url=http://yoursite.com/page/9/&title=刘涤生 - 应尽便须尽&source=像外行一样思考,像专家一样实践。" data-title=" QQ">
          <i class="icon icon-qq"></i>
        </a>
      </li>
      <li>
        <a class="facebook share-sns" target="_blank" href="https://www.facebook.com/sharer/sharer.php?u=http://yoursite.com/page/9/" data-title=" Facebook">
          <i class="icon icon-facebook"></i>
        </a>
      </li>
      <li>
        <a class="twitter share-sns" target="_blank" href="https://twitter.com/intent/tweet?text=刘涤生 - 应尽便须尽&url=http://yoursite.com/page/9/&via=http://yoursite.com" data-title=" Twitter">
          <i class="icon icon-twitter"></i>
        </a>
      </li>
      <li>
        <a class="google share-sns" target="_blank" href="https://plus.google.com/share?url=http://yoursite.com/page/9/" data-title=" Google+">
          <i class="icon icon-google-plus"></i>
        </a>
      </li>
    </ul>
 </div>


<div class="page-modal wx-share" id="wxShare">
    <a class="close" href="javascript:;"><i class="icon icon-close"></i></a>
    <p>扫一扫，分享到微信</p>
    <img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAK4AAACuCAAAAACKZ2kyAAABwklEQVR42u3aQYrDMAwF0N7/0h2Y1cAQ90ty3RSeV6Gk9nMWQpb8eMTj+Tv+P1/9sn7z73i8Y+Di4o65z+XIl7n6V7LtxICLi3uemwev9XTrDefB8fJ3XFzcm3ET3DpxyTeDi4v7XdxeAoSLi/uN3AS0DmqT9OgtZzVcXNwBd1Iw3fV8qL6Li4s77kpUA1wvGSqsiIuLe4S7qxiaNFbzI9CLYIeLi3ucO7kkkWx1w7q4uLhHuEmxYz11tQ1TDZ24uLgnufNjT7Md0qp14OLi3odbPa7kzdRyKwUXF/cIN2lvFLKkQcKUt29xcXHPcKuHkHyxKqtwyQMXF/c4N0EklGpBpJzo4OLivoHbK3kkZY7epa4XHwUXF/cgt3e+yIPXtmMVLi7uEW4+JpReoKxe/sDFxd3FzSeqNlyr4TJaCxcX9wh3Vy7RK4nmM+Pi4p7kzq9kVdsqvXkKt0VwcXHH3L0BK0+P8uIpLi7up7i94011sXX7tpAM4eLiHuTmBYteO6R67LncKi4u7o25o4sUk0+Ai4t7M27v/VHYmqQ4uLi4Y26vjZqw5tsoVHlxcXE3cXstz+plrGpxZFt9FxcXt8b9ASPETdSlxyc8AAAAAElFTkSuQmCC" alt="微信分享二维码">
</div>




  <script src="//cdn.bootcss.com/node-waves/0.7.4/waves.min.js"></script>
<script src="/js/main.min.js?v=1.2.7"></script>



<div class="search-panel" id="search-panel">
    <ul class="search-result" id="search-result"></ul>
</div>
<template id="search-tpl">
<li class="item">
    <a href="{path}" class="waves-block waves-effect">
        <div class="title ellipsis" title="{title}">{title}</div>
        <div class="flex-row flex-middle">
            <div class="tags ellipsis">
                {tags}
            </div>
            <time class="flex-col time">{date}</time>
        </div>
    </a>
</li>
</template>

<script src="/js/search.min.js?v=1.2.7"></script>



<!-- mathjax config similar to math.stackexchange -->

<script type="text/x-mathjax-config">
MathJax.Hub.Config({
    tex2jax: {
        inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
        processEscapes: true,
        skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
});

MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
        all[i].SourceElement().parentNode.className += ' has-jax';                 
    }       
});
</script>

<script type="text/javascript" async src="//cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-MML-AM_CHTML"></script>








</body>
</html>
